<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ad Gateway - Campaign Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      backdrop-filter: blur(10px);
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      letter-spacing: 2px;
    }

    .subtitle {
      font-size: 1rem;
      opacity: 0.8;
      margin-bottom: 15px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 10px;
    }

    .tab {
      padding: 12px 24px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab.active {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
    }

    .tab:hover {
      background: rgba(255,255,255,0.2);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.2);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-change {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .stat-change.positive {
      color: #00ff88;
    }

    .stat-change.negative {
      color: #ff4444;
    }

    .form-section {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 30px;
      border: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 5px;
      color: #fff;
      font-family: inherit;
      font-size: 1rem;
    }

    input::placeholder, textarea::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .checkbox-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="checkbox"] {
      width: auto;
    }

    button {
      background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
      color: #000;
      padding: 14px 32px;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,255,136,0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .campaigns-list {
      display: grid;
      gap: 20px;
    }

    .campaign-card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 25px;
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s;
    }

    .campaign-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .campaign-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 20px;
    }

    .campaign-name {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .campaign-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    .campaign-status.active {
      background: rgba(0,255,136,0.3);
      color: #00ff88;
    }

    .campaign-status.paused {
      background: rgba(255,165,0,0.3);
      color: #ffa500;
    }

    .campaign-status.draft {
      background: rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.8);
    }

    .campaign-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .metric {
      text-align: center;
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .campaign-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.9rem;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }

    .variants-table {
      width: 100%;
      margin-top: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      overflow: hidden;
    }

    .variants-table th,
    .variants-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .variants-table th {
      background: rgba(0,0,0,0.3);
      font-weight: bold;
    }

    .variants-table tr:last-child td {
      border-bottom: none;
    }

    .error-message {
      background: rgba(255,0,0,0.2);
      border: 1px solid rgba(255,0,0,0.5);
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .success-message {
      background: rgba(0,255,136,0.2);
      border: 1px solid rgba(0,255,136,0.5);
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      opacity: 0.7;
    }

    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .help-text {
      font-size: 0.85rem;
      opacity: 0.7;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>📢 Ad Gateway</h1>
      <p class="subtitle">A/B test ad campaigns across AI models • BYOK support • Auto-optimization</p>
    </header>

    <div class="tabs">
      <div class="tab active" data-tab="create">Create Campaign</div>
      <div class="tab" data-tab="campaigns">Active Campaigns</div>
      <div class="tab" data-tab="analytics">Analytics</div>
    </div>

    <div id="error-message" class="error-message"></div>
    <div id="success-message" class="success-message"></div>

    <!-- Create Campaign Tab -->
    <div id="create-tab" class="tab-content active">
      <div class="form-section">
        <h2 style="margin-bottom: 20px;">Create New Campaign</h2>
        <form id="campaign-form">
          <div class="form-group">
            <label for="campaign-name">Campaign Name *</label>
            <input type="text" id="campaign-name" required placeholder="Q1 2024 Crypto Campaign">
          </div>

          <div class="form-group">
            <label for="campaign-description">Description</label>
            <textarea id="campaign-description" rows="3" placeholder="Campaign description (optional)"></textarea>
          </div>

          <div class="form-group">
            <label for="target-vertical">Target Vertical *</label>
            <select id="target-vertical" required>
              <option value="all">All Verticals</option>
              <option value="crypto">Crypto/Web3</option>
              <option value="publishing">Publishing/Content</option>
              <option value="gaming">Gaming/Entertainment</option>
              <option value="dev_tools">Developer Tools</option>
              <option value="sports">Sports/NIL</option>
              <option value="saas">SaaS/B2B</option>
              <option value="ecommerce">E-commerce</option>
            </select>
          </div>

          <div class="form-group">
            <label for="budget">Total Budget (USD) *</label>
            <input type="number" id="budget" required min="100" step="0.01" placeholder="10000">
            <p class="help-text">Minimum $100</p>
          </div>

          <div class="form-group">
            <label for="daily-budget">Daily Budget Limit (USD)</label>
            <input type="number" id="daily-budget" min="0" step="0.01" placeholder="500">
            <p class="help-text">Optional - leave empty for no daily limit</p>
          </div>

          <div class="form-group">
            <label for="ad-copy">Ad Copy *</label>
            <textarea id="ad-copy" rows="4" required placeholder="Trade crypto with AI-powered insights. Get started today!"></textarea>
          </div>

          <div class="form-group">
            <label for="landing-page">Landing Page URL *</label>
            <input type="url" id="landing-page" required placeholder="https://example.com/crypto">
          </div>

          <div class="form-group">
            <label>API Keys (BYOK - Bring Your Own Keys)</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="use-client-keys">
                <label for="use-client-keys" style="margin: 0;">I have my own API keys</label>
              </div>
            </div>
            <p class="help-text">If checked, select which providers you have keys for:</p>
            <div class="checkbox-group" id="provider-keys" style="margin-top: 10px; display: none;">
              <div class="checkbox-item">
                <input type="checkbox" id="has-openai">
                <label for="has-openai" style="margin: 0;">OpenAI</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="has-anthropic">
                <label for="has-anthropic" style="margin: 0;">Anthropic</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="has-deepseek">
                <label for="has-deepseek" style="margin: 0;">DeepSeek</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="pricing-model">Pricing Model *</label>
            <select id="pricing-model" required>
              <option value="commission">Commission (25% of conversions)</option>
              <option value="cpc">Cost Per Click (CPC)</option>
              <option value="cpm">Cost Per Mille (CPM)</option>
              <option value="hybrid">Hybrid (Commission + Platform Fee)</option>
            </select>
          </div>

          <div class="form-group" id="commission-rate-group">
            <label for="commission-rate">Commission Rate (%)</label>
            <input type="number" id="commission-rate" min="0" max="100" step="0.01" value="25" placeholder="25">
          </div>

          <button type="submit">🚀 Create Campaign</button>
        </form>
      </div>
    </div>

    <!-- Campaigns Tab -->
    <div id="campaigns-tab" class="tab-content">
      <div class="loading" id="campaigns-loading">
        <div class="spinner"></div>
        <p>Loading campaigns...</p>
      </div>
      <div id="campaigns-list" class="campaigns-list"></div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics-tab" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Campaigns</div>
          <div class="stat-value" id="total-campaigns">0</div>
          <div class="stat-change positive">+0 this month</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Budget</div>
          <div class="stat-value" id="total-budget">$0</div>
          <div class="stat-change">Across all campaigns</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Conversions</div>
          <div class="stat-value" id="total-conversions">0</div>
          <div class="stat-change positive">+0 this week</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Conversion Rate</div>
          <div class="stat-value" id="avg-conversion-rate">0%</div>
          <div class="stat-change">Across all campaigns</div>
        </div>
      </div>

      <div class="form-section">
        <h2 style="margin-bottom: 20px;">Platform Performance</h2>
        <p>Detailed analytics coming soon...</p>
      </div>
    </div>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Show corresponding content
        const tabName = tab.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');

        // Load campaigns if switching to campaigns tab
        if (tabName === 'campaigns') {
          loadCampaigns();
        }

        // Load analytics if switching to analytics tab
        if (tabName === 'analytics') {
          loadAnalytics();
        }
      });
    });

    // Show/hide provider keys checkboxes
    document.getElementById('use-client-keys').addEventListener('change', (e) => {
      document.getElementById('provider-keys').style.display = e.target.checked ? 'flex' : 'none';
    });

    // Handle campaign form submission
    document.getElementById('campaign-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = {
        campaign_name: document.getElementById('campaign-name').value,
        campaign_description: document.getElementById('campaign-description').value,
        target_vertical: document.getElementById('target-vertical').value,
        budget_cents: Math.round(parseFloat(document.getElementById('budget').value) * 100),
        daily_budget_cents: document.getElementById('daily-budget').value ?
          Math.round(parseFloat(document.getElementById('daily-budget').value) * 100) : null,
        ad_copy: document.getElementById('ad-copy').value,
        landing_page_url: document.getElementById('landing-page').value,
        use_client_keys: document.getElementById('use-client-keys').checked,
        client_has_openai: document.getElementById('has-openai').checked,
        client_has_anthropic: document.getElementById('has-anthropic').checked,
        client_has_deepseek: document.getElementById('has-deepseek').checked,
        pricing_model: document.getElementById('pricing-model').value,
        commission_rate: parseFloat(document.getElementById('commission-rate').value) / 100
      };

      try {
        const response = await fetch('/api/campaigns', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-user-id': '1' // TODO: Get from session
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (result.success) {
          showSuccess(`Campaign "${formData.campaign_name}" created successfully!`);
          document.getElementById('campaign-form').reset();

          // Switch to campaigns tab after 2 seconds
          setTimeout(() => {
            document.querySelector('.tab[data-tab="campaigns"]').click();
          }, 2000);
        } else {
          showError(result.error || 'Failed to create campaign');
        }
      } catch (error) {
        showError('Network error: ' + error.message);
      }
    });

    // Load campaigns
    async function loadCampaigns() {
      const loadingEl = document.getElementById('campaigns-loading');
      const listEl = document.getElementById('campaigns-list');

      loadingEl.style.display = 'block';
      listEl.innerHTML = '';

      try {
        const response = await fetch('/api/campaigns', {
          headers: {
            'x-user-id': '1' // TODO: Get from session
          }
        });

        const result = await response.json();

        if (result.success) {
          loadingEl.style.display = 'none';

          if (result.campaigns.length === 0) {
            listEl.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 40px;">No campaigns yet. Create your first campaign!</p>';
            return;
          }

          result.campaigns.forEach(campaign => {
            listEl.appendChild(createCampaignCard(campaign));
          });
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        loadingEl.style.display = 'none';
        showError('Failed to load campaigns: ' + error.message);
      }
    }

    // Create campaign card
    function createCampaignCard(campaign) {
      const card = document.createElement('div');
      card.className = 'campaign-card';

      const budget = (campaign.budget_cents / 100).toFixed(2);
      const spent = (campaign.spent_cents / 100).toFixed(2);
      const remaining = (campaign.remaining_cents / 100).toFixed(2);
      const conversionRate = (campaign.conversion_rate * 100).toFixed(2);

      card.innerHTML = `
        <div class="campaign-header">
          <div>
            <div class="campaign-name">${campaign.campaign_name}</div>
            <div style="opacity: 0.7; font-size: 0.9rem;">${campaign.target_vertical}</div>
          </div>
          <div class="campaign-status ${campaign.status}">${campaign.status}</div>
        </div>

        <div class="campaign-metrics">
          <div class="metric">
            <div class="metric-value">${campaign.total_impressions || 0}</div>
            <div class="metric-label">Impressions</div>
          </div>
          <div class="metric">
            <div class="metric-value">${campaign.total_clicks || 0}</div>
            <div class="metric-label">Clicks</div>
          </div>
          <div class="metric">
            <div class="metric-value">${campaign.total_conversions || 0}</div>
            <div class="metric-label">Conversions</div>
          </div>
          <div class="metric">
            <div class="metric-value">${conversionRate}%</div>
            <div class="metric-label">Conv. Rate</div>
          </div>
          <div class="metric">
            <div class="metric-value">$${budget}</div>
            <div class="metric-label">Budget</div>
          </div>
          <div class="metric">
            <div class="metric-value">$${spent}</div>
            <div class="metric-label">Spent</div>
          </div>
          <div class="metric">
            <div class="metric-value">$${remaining}</div>
            <div class="metric-label">Remaining</div>
          </div>
        </div>

        <div class="campaign-actions">
          ${campaign.status === 'draft' ?
            `<button class="btn-small" onclick="startCampaign('${campaign.campaign_id}')">▶️ Start Campaign</button>` :
            campaign.status === 'active' ?
            `<button class="btn-small btn-secondary" onclick="pauseCampaign('${campaign.campaign_id}')">⏸️ Pause</button>` :
            `<button class="btn-small" onclick="startCampaign('${campaign.campaign_id}')">▶️ Resume</button>`
          }
          <button class="btn-small btn-secondary" onclick="viewVariants('${campaign.campaign_id}')">📊 View A/B Tests</button>
        </div>

        <div id="variants-${campaign.campaign_id}"></div>
      `;

      return card;
    }

    // Start campaign
    async function startCampaign(campaignId) {
      try {
        const response = await fetch(`/api/campaigns/${campaignId}/start`, {
          method: 'POST',
          headers: {
            'x-user-id': '1'
          }
        });

        const result = await response.json();

        if (result.success) {
          showSuccess('Campaign started successfully!');
          loadCampaigns();
        } else {
          showError(result.error || 'Failed to start campaign');
        }
      } catch (error) {
        showError('Network error: ' + error.message);
      }
    }

    // Pause campaign
    async function pauseCampaign(campaignId) {
      try {
        const response = await fetch(`/api/campaigns/${campaignId}/pause`, {
          method: 'POST',
          headers: {
            'x-user-id': '1'
          }
        });

        const result = await response.json();

        if (result.success) {
          showSuccess('Campaign paused successfully!');
          loadCampaigns();
        } else {
          showError(result.error || 'Failed to pause campaign');
        }
      } catch (error) {
        showError('Network error: ' + error.message);
      }
    }

    // View A/B test variants
    async function viewVariants(campaignId) {
      const variantsEl = document.getElementById(`variants-${campaignId}`);

      if (variantsEl.innerHTML) {
        // Toggle off if already showing
        variantsEl.innerHTML = '';
        return;
      }

      try {
        const response = await fetch(`/api/campaigns/${campaignId}/variants`, {
          headers: {
            'x-user-id': '1'
          }
        });

        const result = await response.json();

        if (result.success) {
          let html = '<table class="variants-table"><thead><tr>';
          html += '<th>Variant</th><th>Provider</th><th>Model</th><th>Impressions</th>';
          html += '<th>Clicks</th><th>Conversions</th><th>CTR</th><th>Conv. Rate</th>';
          html += '<th>Traffic</th></tr></thead><tbody>';

          result.variants.forEach(variant => {
            const ctr = (variant.click_through_rate * 100).toFixed(2);
            const convRate = (variant.conversion_rate * 100).toFixed(2);
            const traffic = (variant.traffic_weight * 100).toFixed(0);

            html += `<tr>
              <td>${variant.variant_name}</td>
              <td>${variant.ai_provider}</td>
              <td>${variant.ai_model}</td>
              <td>${variant.impressions}</td>
              <td>${variant.clicks}</td>
              <td>${variant.conversions}</td>
              <td>${ctr}%</td>
              <td>${convRate}%</td>
              <td>${traffic}%</td>
            </tr>`;
          });

          html += '</tbody></table>';
          variantsEl.innerHTML = html;
        } else {
          showError(result.error || 'Failed to load variants');
        }
      } catch (error) {
        showError('Network error: ' + error.message);
      }
    }

    // Load analytics
    async function loadAnalytics() {
      try {
        const response = await fetch('/api/campaigns', {
          headers: {
            'x-user-id': '1'
          }
        });

        const result = await response.json();

        if (result.success) {
          const campaigns = result.campaigns;

          document.getElementById('total-campaigns').textContent = campaigns.length;

          const totalBudget = campaigns.reduce((sum, c) => sum + (c.budget_cents || 0), 0) / 100;
          document.getElementById('total-budget').textContent = '$' + totalBudget.toFixed(2);

          const totalConversions = campaigns.reduce((sum, c) => sum + (c.total_conversions || 0), 0);
          document.getElementById('total-conversions').textContent = totalConversions;

          const avgConvRate = campaigns.length > 0 ?
            campaigns.reduce((sum, c) => sum + (c.conversion_rate || 0), 0) / campaigns.length : 0;
          document.getElementById('avg-conversion-rate').textContent = (avgConvRate * 100).toFixed(2) + '%';
        }
      } catch (error) {
        showError('Failed to load analytics: ' + error.message);
      }
    }

    // Show error message
    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }

    // Show success message
    function showSuccess(message) {
      const successEl = document.getElementById('success-message');
      successEl.textContent = message;
      successEl.style.display = 'block';
      setTimeout(() => {
        successEl.style.display = 'none';
      }, 5000);
    }

    // Load campaigns on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadCampaigns();
    });
  </script>
</body>
</html>
