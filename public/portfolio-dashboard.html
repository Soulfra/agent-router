<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Hub - CALOS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
    }

    .stat-subtitle {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab {
      background: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      color: #667eea;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .tab.active {
      background: #667eea;
      color: white;
    }

    .tab:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
    }

    .timeline {
      position: relative;
      padding-left: 40px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 12px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e0e0e0;
    }

    .timeline-item {
      position: relative;
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -33px;
      top: 25px;
      width: 12px;
      height: 12px;
      background: #667eea;
      border-radius: 50%;
      border: 3px solid white;
    }

    .timeline-date {
      font-size: 12px;
      color: #999;
      margin-bottom: 5px;
    }

    .timeline-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .timeline-description {
      font-size: 14px;
      color: #666;
    }

    .git-chart {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(12px, 1fr));
      gap: 3px;
      margin: 20px 0;
    }

    .git-day {
      width: 12px;
      height: 12px;
      background: #eee;
      border-radius: 2px;
    }

    .git-day.level-1 { background: #c6e48b; }
    .git-day.level-2 { background: #7bc96f; }
    .git-day.level-3 { background: #239a3b; }
    .git-day.level-4 { background: #196127; }

    .language-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin: 15px 0;
      display: flex;
    }

    .language-segment {
      height: 100%;
      transition: width 0.3s;
    }

    .language-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .language-badge {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      background: #f0f0f0;
      border-radius: 12px;
      font-size: 12px;
    }

    .language-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-secondary:hover {
      background: #f0f2ff;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: #e0e7ff;
      color: #667eea;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .settings-form {
      display: grid;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toggle input[type="checkbox"] {
      width: 50px;
      height: 26px;
      appearance: none;
      background: #ddd;
      border-radius: 13px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle input[type="checkbox"]:checked {
      background: #667eea;
    }

    .toggle input[type="checkbox"]::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: left 0.3s;
    }

    .toggle input[type="checkbox"]:checked::before {
      left: 27px;
    }

    .ip-registry-item {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .ip-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .ip-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .ip-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .ip-status.draft { background: #f0f0f0; color: #666; }
    .ip-status.filed { background: #fff3cd; color: #856404; }
    .ip-status.registered { background: #d4edda; color: #155724; }

    .ip-meta {
      display: flex;
      gap: 20px;
      font-size: 13px;
      color: #666;
      margin-top: 10px;
    }

    .proof-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      background: #d4edda;
      color: #155724;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    .leaderboard-rank {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
      min-width: 40px;
    }

    .leaderboard-info {
      flex: 1;
    }

    .leaderboard-karma {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Portfolio Hub</h1>
      <p class="subtitle">Unified analytics across AI chats, git activity, embed analytics, and authorship</p>
    </header>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading portfolio data...</p>
    </div>

    <!-- Main Content -->
    <div id="content" style="display: none;">
      <!-- Overview Stats -->
      <div class="stats-grid" id="statsGrid"></div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('timeline')">Timeline</button>
        <button class="tab" onclick="switchTab('git')">Git Stats</button>
        <button class="tab" onclick="switchTab('ip')">IP Registry</button>
        <button class="tab" onclick="switchTab('analytics')">Analytics</button>
        <button class="tab" onclick="switchTab('rewards')">Rewards</button>
        <button class="tab" onclick="switchTab('leaderboard')">Leaderboard</button>
        <button class="tab" onclick="switchTab('settings')">Settings</button>
      </div>

      <!-- Tab Contents -->
      <div id="timeline" class="tab-content active">
        <div class="section">
          <h2 class="section-title">Activity Timeline</h2>
          <div class="timeline" id="timelineContent"></div>
        </div>
      </div>

      <div id="git" class="tab-content">
        <div class="section">
          <h2 class="section-title">Git Portfolio</h2>
          <div id="gitContent"></div>
        </div>
      </div>

      <div id="ip" class="tab-content">
        <div class="section">
          <h2 class="section-title">Intellectual Property Registry</h2>
          <button class="btn" style="margin-bottom: 20px;" onclick="registerNewIP()">+ Register New IP</button>
          <div id="ipContent"></div>
        </div>
      </div>

      <div id="analytics" class="tab-content">
        <div class="section">
          <h2 class="section-title">Daily Analytics</h2>
          <div id="analyticsContent"></div>
        </div>
      </div>

      <div id="rewards" class="tab-content">
        <div class="section">
          <h2 class="section-title">Mining & Rewards</h2>
          <div id="rewardsContent"></div>
        </div>
      </div>

      <div id="leaderboard" class="tab-content">
        <div class="section">
          <h2 class="section-title">Karma Leaderboard</h2>
          <div id="leaderboardContent"></div>
        </div>
      </div>

      <div id="settings" class="tab-content">
        <div class="section">
          <h2 class="section-title">Portfolio Settings</h2>
          <div class="settings-form" id="settingsForm"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let portfolioData = {};

    // Load portfolio data
    async function loadPortfolio() {
      try {
        const [overview, timeline, gitStats, ipRegistry, rewards, settings] = await Promise.all([
          fetch('/api/portfolio/overview').then(r => r.json()),
          fetch('/api/portfolio/timeline?limit=50').then(r => r.json()),
          fetch('/api/portfolio/git-stats').then(r => r.json()),
          fetch('/api/portfolio/ip-registry').then(r => r.json()),
          fetch('/api/portfolio/rewards').then(r => r.json()),
          fetch('/api/portfolio/settings').then(r => r.json())
        ]);

        portfolioData = { overview, timeline, gitStats, ipRegistry, rewards, settings };

        renderOverview(overview);
        renderTimeline(timeline);
        renderGitStats(gitStats);
        renderIPRegistry(ipRegistry);
        renderRewards(rewards);
        renderSettings(settings);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading portfolio:', error);
        document.getElementById('loading').innerHTML = '<p>Error loading portfolio data. Please check authentication.</p>';
      }
    }

    function renderOverview(data) {
      if (!data) return;

      const stats = [
        { label: 'AI Conversations', value: data.total_ai_conversations?.toLocaleString() || '0', subtitle: `${data.total_ai_cost || 0} USD cost` },
        { label: 'Git Commits', value: data.total_git_commits?.toLocaleString() || '0', subtitle: `${data.total_git_prs || 0} PRs` },
        { label: 'Embed Events', value: data.total_embed_events?.toLocaleString() || '0', subtitle: 'Total tracked' },
        { label: 'IP Filings', value: data.total_ip_filings?.toLocaleString() || '0', subtitle: 'Patents & Trademarks' }
      ];

      document.getElementById('statsGrid').innerHTML = stats.map(stat => `
        <div class="stat-card">
          <div class="stat-label">${stat.label}</div>
          <div class="stat-value">${stat.value}</div>
          <div class="stat-subtitle">${stat.subtitle}</div>
        </div>
      `).join('');
    }

    function renderTimeline(data) {
      if (!data || data.length === 0) {
        document.getElementById('timelineContent').innerHTML = '<p style="color: #999;">No activity yet</p>';
        return;
      }

      document.getElementById('timelineContent').innerHTML = data.map(item => {
        const date = new Date(item.event_timestamp);
        return `
          <div class="timeline-item">
            <div class="timeline-date">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
            <div class="timeline-title">${item.title || item.event_type}</div>
            <div class="timeline-description">${item.description || ''}</div>
            ${item.event_category ? `<span class="badge" style="margin-top: 8px;">${item.event_category}</span>` : ''}
          </div>
        `;
      }).join('');
    }

    function renderGitStats(data) {
      if (!data || data.length === 0) {
        document.getElementById('gitContent').innerHTML = '<p style="color: #999;">No git accounts synced yet. <button class="btn" onclick="syncGit()">Sync Git Accounts</button></p>';
        return;
      }

      document.getElementById('gitContent').innerHTML = data.map(platform => {
        const languages = platform.languages ? JSON.parse(platform.languages) : {};
        const totalLanguages = Object.values(languages).reduce((a, b) => a + b, 0);

        return `
          <div style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #f0f0f0;">
            <h3 style="margin-bottom: 15px;">${platform.platform.toUpperCase()}: ${platform.username}</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div><strong>Repos:</strong> ${platform.total_repos}</div>
              <div><strong>Commits:</strong> ${platform.total_commits}</div>
              <div><strong>Stars:</strong> ${platform.total_stars}</div>
              <div><strong>Forks:</strong> ${platform.total_forks}</div>
            </div>
            ${renderLanguages(languages, totalLanguages)}
            <div style="margin-top: 10px; font-size: 12px; color: #999;">Last synced: ${new Date(platform.last_synced_at).toLocaleString()}</div>
          </div>
        `;
      }).join('');
    }

    function renderLanguages(languages, total) {
      const colors = { JavaScript: '#f1e05a', Python: '#3572A5', Go: '#00ADD8', Rust: '#dea584', TypeScript: '#2b7489', Java: '#b07219' };
      const entries = Object.entries(languages).sort((a, b) => b[1] - a[1]);

      return `
        <div class="language-bar">
          ${entries.map(([lang, count]) => `
            <div class="language-segment" style="width: ${(count / total) * 100}%; background: ${colors[lang] || '#ccc'};"></div>
          `).join('')}
        </div>
        <div class="language-list">
          ${entries.map(([lang, count]) => `
            <div class="language-badge">
              <div class="language-dot" style="background: ${colors[lang] || '#ccc'};"></div>
              <span>${lang} (${Math.round((count / total) * 100)}%)</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderIPRegistry(data) {
      if (!data || data.length === 0) {
        document.getElementById('ipContent').innerHTML = '<p style="color: #999; margin-top: 20px;">No IP registered yet</p>';
        return;
      }

      document.getElementById('ipContent').innerHTML = data.map(ip => `
        <div class="ip-registry-item">
          <div class="ip-header">
            <div class="ip-title">${ip.title}</div>
            <div class="ip-status ${ip.status}">${ip.status}</div>
          </div>
          <div style="color: #666; margin-bottom: 10px;">${ip.description || ''}</div>
          <div class="ip-meta">
            <span>Type: <strong>${ip.ip_type}</strong></span>
            ${ip.filing_number ? `<span>Filing: ${ip.filing_number}</span>` : ''}
            ${ip.jurisdiction ? `<span>Jurisdiction: ${ip.jurisdiction}</span>` : ''}
          </div>
          ${ip.soulfra_hash ? `<div style="margin-top: 10px;"><span class="proof-badge">üîê Soulfra Verified</span></div>` : ''}
        </div>
      `).join('');
    }

    function renderRewards(data) {
      if (!data || data.length === 0) {
        document.getElementById('rewardsContent').innerHTML = '<p style="color: #999;">No rewards unlocked yet. Keep contributing to earn karma!</p>';
        return;
      }

      document.getElementById('rewardsContent').innerHTML = data.map(reward => `
        <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${reward.reward_name}</strong>
              <div style="color: #999; font-size: 13px; margin-top: 5px;">${reward.karma_threshold} karma required</div>
            </div>
            ${reward.redeemed_at ?
              `<span class="badge" style="background: #d4edda; color: #155724;">Redeemed</span>` :
              `<button class="btn" style="padding: 8px 16px;" onclick="redeemReward(${reward.id})">Redeem</button>`
            }
          </div>
        </div>
      `).join('');
    }

    function renderSettings(data) {
      document.getElementById('settingsForm').innerHTML = `
        <div class="form-group toggle">
          <input type="checkbox" id="isPublic" ${data.is_public ? 'checked' : ''}>
          <label for="isPublic">Make portfolio public</label>
        </div>
        ${data.is_public ? `
          <div class="form-group">
            <label for="publicSlug">Public URL Slug</label>
            <input type="text" id="publicSlug" value="${data.public_url_slug || ''}" placeholder="your-name">
            <small style="color: #999;">Portfolio will be at: /portfolio/${data.public_url_slug || 'your-slug'}</small>
          </div>
        ` : ''}
        <div class="form-group toggle">
          <input type="checkbox" id="showAiStats" ${data.show_ai_stats ? 'checked' : ''}>
          <label for="showAiStats">Show AI Stats</label>
        </div>
        <div class="form-group toggle">
          <input type="checkbox" id="showGitStats" ${data.show_git_stats ? 'checked' : ''}>
          <label for="showGitStats">Show Git Stats</label>
        </div>
        <div class="form-group toggle">
          <input type="checkbox" id="showEmbedStats" ${data.show_embed_stats ? 'checked' : ''}>
          <label for="showEmbedStats">Show Embed Stats</label>
        </div>
        <button class="btn" onclick="saveSettings()">Save Settings</button>
      `;
    }

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');

      // Load specific tab data if needed
      if (tabName === 'leaderboard') loadLeaderboard();
      if (tabName === 'analytics') loadAnalytics();
    }

    async function loadLeaderboard() {
      try {
        const data = await fetch('/api/portfolio/leaderboard?limit=100').then(r => r.json());
        document.getElementById('leaderboardContent').innerHTML = data.map((user, i) => `
          <div class="leaderboard-item">
            <div class="leaderboard-rank">#${i + 1}</div>
            <div class="leaderboard-info">
              <div class="leaderboard-karma">${user.karma} karma</div>
              <div style="font-size: 13px; color: #666;">User ${user.user_id} ‚Ä¢ ${user.badge || 'Newcomer'}</div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading leaderboard:', error);
      }
    }

    async function loadAnalytics() {
      try {
        const data = await fetch('/api/portfolio/analytics').then(r => r.json());
        document.getElementById('analyticsContent').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    async function saveSettings() {
      const settings = {
        isPublic: document.getElementById('isPublic').checked,
        publicUrlSlug: document.getElementById('publicSlug')?.value,
        showAiStats: document.getElementById('showAiStats').checked,
        showGitStats: document.getElementById('showGitStats').checked,
        showEmbedStats: document.getElementById('showEmbedStats').checked
      };

      try {
        await fetch('/api/portfolio/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        alert('Settings saved!');
        loadPortfolio();
      } catch (error) {
        console.error('Error saving settings:', error);
        alert('Error saving settings');
      }
    }

    function registerNewIP() {
      alert('IP registration form coming soon!');
    }

    function syncGit() {
      alert('Git sync form coming soon!');
    }

    async function redeemReward(rewardId) {
      try {
        await fetch(`/api/portfolio/rewards/${rewardId}/redeem`, { method: 'POST' });
        alert('Reward redeemed!');
        loadPortfolio();
      } catch (error) {
        console.error('Error redeeming reward:', error);
        alert('Error redeeming reward');
      }
    }

    // Load on page load
    loadPortfolio();
  </script>
</body>
</html>
