<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocStream - Interactive OAuth Documentation</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-dark: #0a0a0a;
      --bg-medium: #1a1a1a;
      --bg-light: #252525;
      --border: #333;
      --text-primary: #e0e0e0;
      --text-secondary: #888;
      --accent-blue: #0080ff;
      --accent-green: #00ff88;
      --accent-yellow: #ffaa00;
      --accent-red: #ff4444;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      overflow: hidden;
      height: 100vh;
    }

    /* Main Layout */
    .container {
      display: grid;
      grid-template-columns: 300px 1fr 320px;
      grid-template-rows: 60px 1fr;
      height: 100vh;
      gap: 0;
    }

    /* Header */
    .header {
      grid-column: 1 / -1;
      background: var(--bg-medium);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 20px;
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .search-box {
      flex: 1;
      max-width: 600px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 10px 40px 10px 15px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      pointer-events: none;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Sidebar - Search & Results */
    .sidebar {
      background: var(--bg-medium);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 20px;
    }

    .sidebar h3 {
      font-size: 14px;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 15px;
      font-weight: 600;
    }

    .filters {
      margin-bottom: 25px;
    }

    .filter-group {
      margin-bottom: 15px;
    }

    .filter-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }

    .filter-label:hover {
      background: var(--bg-light);
    }

    .filter-label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .result-card {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .result-card:hover {
      border-color: var(--accent-blue);
      transform: translateY(-2px);
    }

    .result-card.active {
      border-color: var(--accent-blue);
      background: rgba(0, 128, 255, 0.1);
    }

    .result-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .result-status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .result-status.current { background: var(--accent-green); }
    .result-status.outdated { background: var(--accent-yellow); }
    .result-status.broken { background: var(--accent-red); }

    .result-title {
      font-weight: 600;
      font-size: 15px;
    }

    .result-meta {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .result-thumbnail {
      width: 100%;
      height: 120px;
      background: var(--bg-dark);
      border-radius: 6px;
      margin-top: 10px;
      object-fit: cover;
    }

    /* Main Viewer */
    .viewer {
      background: var(--bg-dark);
      overflow-y: auto;
      padding: 30px;
    }

    .viewer-header {
      margin-bottom: 25px;
    }

    .viewer-title {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .viewer-meta {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--bg-medium);
      border-radius: 4px;
    }

    .video-container {
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 25px;
      position: relative;
    }

    .video-player {
      width: 100%;
      max-height: 600px;
      display: block;
    }

    .video-controls {
      padding: 15px 20px;
      background: var(--bg-medium);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .play-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-blue);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: transform 0.2s;
    }

    .play-button:hover {
      transform: scale(1.1);
    }

    .progress-bar {
      flex: 1;
      height: 6px;
      background: var(--bg-light);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-blue);
      border-radius: 3px;
      width: 0%;
      transition: width 0.1s;
    }

    .time-display {
      font-size: 13px;
      color: var(--text-secondary);
      min-width: 100px;
      text-align: right;
    }

    .steps-container {
      margin-top: 30px;
    }

    .step-card {
      background: var(--bg-medium);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
    }

    .step-card:hover {
      border-color: var(--accent-blue);
    }

    .step-card.active {
      border-color: var(--accent-green);
      background: rgba(0, 255, 136, 0.05);
    }

    .step-number {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--accent-blue);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 12px;
    }

    .step-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .step-description {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .step-timestamp {
      font-size: 12px;
      color: var(--accent-blue);
      margin-top: 8px;
    }

    /* Notes Panel */
    .notes-panel {
      background: var(--bg-medium);
      border-left: 1px solid var(--border);
      overflow-y: auto;
      padding: 20px;
    }

    .notes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .notes-title {
      font-size: 16px;
      font-weight: 600;
    }

    .add-note-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--accent-blue);
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .add-note-btn:hover {
      background: var(--accent-green);
    }

    .note-card {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .note-timestamp {
      font-size: 12px;
      color: var(--accent-blue);
      cursor: pointer;
    }

    .note-timestamp:hover {
      text-decoration: underline;
    }

    .note-text {
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .note-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .note-tag {
      font-size: 11px;
      padding: 3px 8px;
      background: var(--bg-dark);
      border-radius: 4px;
      color: var(--text-secondary);
    }

    .note-input {
      width: 100%;
      padding: 12px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
      margin-bottom: 12px;
    }

    .note-input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .note-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-green);
    }

    .btn-secondary {
      background: var(--bg-dark);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-light);
    }

    .progress-section {
      margin-top: 30px;
      padding: 15px;
      background: var(--bg-light);
      border-radius: 8px;
    }

    .progress-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .progress-tracker {
      height: 8px;
      background: var(--bg-dark);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-tracker-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
      width: 0%;
      transition: width 0.3s;
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .ai-assistant {
      margin-top: 20px;
      padding: 15px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .ai-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .ai-input {
      width: 100%;
      padding: 10px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      margin-bottom: 8px;
    }

    .ai-input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .empty-state-text {
      font-size: 14px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-light);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border);
    }

    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 260px 1fr 280px;
      }
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: 60px auto 1fr;
      }

      .sidebar, .notes-panel {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">📚 DocStream</div>
      <div class="search-box">
        <input type="text" class="search-input" placeholder="Search OAuth tutorials..." id="searchInput">
        <span class="search-icon">🔍</span>
      </div>
      <div class="status-indicator">
        <div class="status-dot"></div>
        <span>Live</span>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <h3>Filters</h3>
      <div class="filters">
        <div class="filter-group">
          <label class="filter-label">
            <input type="checkbox" checked data-filter="oauth">
            <span>OAuth Tutorials</span>
          </label>
          <label class="filter-label">
            <input type="checkbox" checked data-filter="current">
            <span>✅ Current</span>
          </label>
          <label class="filter-label">
            <input type="checkbox" data-filter="outdated">
            <span>⚠️ Outdated</span>
          </label>
        </div>
      </div>

      <h3>Providers</h3>
      <div id="resultsContainer">
        <!-- Results will be loaded here -->
        <div class="empty-state">
          <div class="empty-state-text">Loading tutorials...</div>
        </div>
      </div>
    </div>

    <!-- Viewer -->
    <div class="viewer">
      <div id="viewerContent">
        <div class="empty-state">
          <div class="empty-state-icon">🎬</div>
          <div class="empty-state-title">Select a Tutorial</div>
          <div class="empty-state-text">Choose an OAuth provider from the sidebar to get started</div>
        </div>
      </div>
    </div>

    <!-- Notes Panel -->
    <div class="notes-panel">
      <div class="notes-header">
        <div class="notes-title">My Notes</div>
        <button class="add-note-btn" onclick="showNoteInput()">+</button>
      </div>

      <div id="noteInputContainer" style="display: none; margin-bottom: 20px;">
        <textarea class="note-input" placeholder="Add your note..." id="noteTextarea"></textarea>
        <div class="note-actions">
          <button class="btn btn-primary" onclick="saveNote()">Save</button>
          <button class="btn btn-secondary" onclick="hideNoteInput()">Cancel</button>
        </div>
      </div>

      <div id="notesContainer">
        <!-- Notes will be loaded here -->
      </div>

      <div class="progress-section">
        <div class="progress-title">Progress</div>
        <div class="progress-tracker">
          <div class="progress-tracker-fill" id="progressFill"></div>
        </div>
        <div class="progress-stats">
          <span id="progressText">0 of 0 steps</span>
          <span id="progressPercent">0%</span>
        </div>
      </div>

      <div class="ai-assistant">
        <div class="ai-header">
          🤖 AI Assistant
        </div>
        <input type="text" class="ai-input" placeholder="Ask a question..." id="aiInput">
        <button class="btn btn-primary" style="width: 100%;" onclick="askAI()">Ask</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let currentSnapshot = null;
    let currentVideo = null;
    let websocket = null;
    let notes = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadProviders();
      setupSearch();
      setupWebSocket();
    });

    // Load available providers
    async function loadProviders() {
      try {
        const response = await fetch('/api/docs/providers');
        const data = await response.json();

        const container = document.getElementById('resultsContainer');
        container.innerHTML = '';

        if (data.providers && data.providers.length > 0) {
          data.providers.forEach(provider => {
            const card = createResultCard(provider);
            container.appendChild(card);
          });
        } else {
          container.innerHTML = '<div class="empty-state-text">No tutorials found</div>';
        }
      } catch (error) {
        console.error('Failed to load providers:', error);
      }
    }

    // Create result card
    function createResultCard(provider) {
      const card = document.createElement('div');
      card.className = 'result-card';
      card.onclick = () => loadTutorial(provider.snapshot_id);

      const statusClass = provider.status || 'current';
      const timeAgo = provider.last_verified ? formatTimeAgo(new Date(provider.last_verified)) : 'Never';

      card.innerHTML = `
        <div class="result-header">
          <div class="result-status ${statusClass}"></div>
          <div class="result-title">${provider.provider_title || provider.provider}</div>
        </div>
        <div class="result-meta">Updated ${timeAgo}</div>
        ${provider.screenshot_path ? `<img src="${provider.screenshot_path}" class="result-thumbnail" alt="${provider.provider}">` : ''}
      `;

      return card;
    }

    // Load tutorial
    async function loadTutorial(snapshotId) {
      try {
        const response = await fetch(`/api/docs/snapshot/${snapshotId}`);
        const data = await response.json();

        currentSnapshot = data;
        displayTutorial(data);
        loadNotes(snapshotId);

        // Mark as active
        document.querySelectorAll('.result-card').forEach(card => card.classList.remove('active'));
        event.currentTarget.classList.add('active');
      } catch (error) {
        console.error('Failed to load tutorial:', error);
      }
    }

    // Display tutorial
    function displayTutorial(data) {
      const container = document.getElementById('viewerContent');

      let videoHTML = '';
      if (data.video_path || data.gif_path) {
        const mediaPath = data.video_path || data.gif_path;
        videoHTML = `
          <div class="video-container">
            <video class="video-player" id="tutorialVideo" controls>
              <source src="${mediaPath}" type="${data.video_path ? 'video/mp4' : 'image/gif'}">
            </video>
          </div>
        `;
      }

      let stepsHTML = '';
      if (data.annotations && data.annotations.length > 0) {
        stepsHTML = `
          <div class="steps-container">
            ${data.annotations.map((step, index) => `
              <div class="step-card" onclick="jumpToStep(${step.start_time || index * 5})">
                <div class="step-number">${index + 1}</div>
                <div class="step-title">${step.step_title || `Step ${index + 1}`}</div>
                <div class="step-description">${step.step_description || step.text_content || ''}</div>
                ${step.start_time ? `<div class="step-timestamp">⏱️ ${formatTime(step.start_time)}</div>` : ''}
              </div>
            `).join('')}
          </div>
        `;
      }

      container.innerHTML = `
        <div class="viewer-header">
          <div class="viewer-title">${data.page_title || data.provider} OAuth Setup</div>
          <div class="viewer-meta">
            <div class="meta-badge">
              📅 Last verified: ${formatTimeAgo(new Date(data.last_verified_at || data.created_at))}
            </div>
            <div class="meta-badge">
              📊 ${data.step_count || 0} steps
            </div>
            <div class="meta-badge">
              ⚡ Status: ${data.status}
            </div>
          </div>
        </div>
        ${videoHTML}
        ${stepsHTML}
      `;

      // Setup video if present
      if (data.video_path) {
        setupVideoPlayer();
      }
    }

    // Setup video player
    function setupVideoPlayer() {
      currentVideo = document.getElementById('tutorialVideo');
      if (!currentVideo) return;

      currentVideo.addEventListener('timeupdate', () => {
        updateProgress();
        highlightCurrentStep();
      });
    }

    // Jump to step
    function jumpToStep(timestamp) {
      if (currentVideo) {
        currentVideo.currentTime = timestamp;
        currentVideo.play();
      }
    }

    // Update progress
    function updateProgress() {
      if (!currentVideo || !currentSnapshot) return;

      const progress = (currentVideo.currentTime / currentVideo.duration) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      document.getElementById('progressPercent').textContent = Math.round(progress) + '%';

      if (currentSnapshot.annotations) {
        const completed = currentSnapshot.annotations.filter(a =>
          a.start_time && currentVideo.currentTime > a.start_time
        ).length;
        document.getElementById('progressText').textContent =
          `${completed} of ${currentSnapshot.annotations.length} steps`;
      }
    }

    // Highlight current step
    function highlightCurrentStep() {
      if (!currentVideo || !currentSnapshot || !currentSnapshot.annotations) return;

      const currentTime = currentVideo.currentTime;
      document.querySelectorAll('.step-card').forEach((card, index) => {
        const annotation = currentSnapshot.annotations[index];
        if (annotation && annotation.start_time) {
          if (currentTime >= annotation.start_time &&
              currentTime < (currentSnapshot.annotations[index + 1]?.start_time || currentVideo.duration)) {
            card.classList.add('active');
          } else {
            card.classList.remove('active');
          }
        }
      });
    }

    // Notes functions
    function showNoteInput() {
      document.getElementById('noteInputContainer').style.display = 'block';
      document.getElementById('noteTextarea').focus();
    }

    function hideNoteInput() {
      document.getElementById('noteInputContainer').style.display = 'none';
      document.getElementById('noteTextarea').value = '';
    }

    async function saveNote() {
      const text = document.getElementById('noteTextarea').value;
      if (!text || !currentSnapshot) return;

      const timestamp = currentVideo ? currentVideo.currentTime : null;

      try {
        const response = await fetch('/api/docs/notes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            snapshot_id: currentSnapshot.snapshot_id,
            timestamp,
            note_text: text,
            tags: []
          })
        });

        if (response.ok) {
          hideNoteInput();
          loadNotes(currentSnapshot.snapshot_id);
        }
      } catch (error) {
        console.error('Failed to save note:', error);
      }
    }

    async function loadNotes(snapshotId) {
      try {
        const response = await fetch(`/api/docs/notes/${snapshotId}`);
        const data = await response.json();

        const container = document.getElementById('notesContainer');
        if (data.notes && data.notes.length > 0) {
          container.innerHTML = data.notes.map(note => `
            <div class="note-card">
              ${note.timestamp ? `
                <div class="note-header">
                  <div class="note-timestamp" onclick="jumpToStep(${note.timestamp})">
                    ⏱️ ${formatTime(note.timestamp)}
                  </div>
                </div>
              ` : ''}
              <div class="note-text">${note.note_text}</div>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<div class="empty-state-text">No notes yet</div>';
        }
      } catch (error) {
        console.error('Failed to load notes:', error);
      }
    }

    // AI Assistant
    async function askAI() {
      const question = document.getElementById('aiInput').value;
      if (!question) return;

      // TODO: Implement AI assistant integration
      alert('AI Assistant integration coming soon!');
    }

    // Search
    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      let debounceTimer;

      searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          performSearch(searchInput.value);
        }, 300);
      });
    }

    async function performSearch(query) {
      if (!query) {
        loadProviders();
        return;
      }

      // TODO: Implement search
      console.log('Searching for:', query);
    }

    // WebSocket
    function setupWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      websocket = new WebSocket(`${protocol}//${window.location.host}`);

      websocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'doc_update') {
          loadProviders();
        }
      };
    }

    // Utility functions
    function formatTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
  </script>
</body>
</html>
