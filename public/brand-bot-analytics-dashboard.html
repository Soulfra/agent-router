<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brand & Bot Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
      text-align: center;
      opacity: 0.9;
      margin-bottom: 30px;
      font-size: 1.1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-change {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .chart-card h3 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.3rem;
    }

    .awol-events {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .awol-events h3 {
      color: #667eea;
      margin-bottom: 20px;
    }

    .awol-event {
      background: #f8f9fa;
      border-left: 4px solid #ff6b6b;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }

    .awol-event .bot-name {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .awol-event .message {
      color: #333;
      font-style: italic;
      margin: 10px 0;
      padding: 10px;
      background: #fff;
      border-radius: 5px;
    }

    .awol-event .metadata {
      font-size: 0.85rem;
      color: #666;
      margin-top: 8px;
    }

    .funny-moments {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
    }

    .funny-moments h3 {
      color: #667eea;
      margin-bottom: 20px;
    }

    .funny-moment {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }

    .funny-moment .brand {
      font-weight: bold;
      color: #ff6b00;
      margin-bottom: 5px;
    }

    .funny-moment .message {
      color: #333;
      margin: 10px 0;
    }

    .funniness-score {
      display: inline-block;
      background: #ffc107;
      color: #333;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .refresh-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.5);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: all 0.3s;
      display: block;
      margin: 30px auto;
    }

    .refresh-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: white;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
    }

    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”¥ Brand & Bot Analytics Dashboard</h1>
    <p class="subtitle">Track brand engagement, bot personalities, and funny moments</p>

    <!-- Key Stats -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-label">Total Brands</div>
        <div class="stat-value" id="totalBrands">-</div>
        <div class="stat-change">Active brands being tracked</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">AWOL Events</div>
        <div class="stat-value" id="totalAwol">-</div>
        <div class="stat-change">Bots that went crazy</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Funny Moments</div>
        <div class="stat-value" id="totalFunny">-</div>
        <div class="stat-change">Hilarious bot interactions</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Model Interactions</div>
        <div class="stat-value" id="totalModels">-</div>
        <div class="stat-change">AI model usage count</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3>ðŸ“Š Brand Engagement</h3>
        <canvas id="brandChart"></canvas>
      </div>

      <div class="chart-card">
        <h3>ðŸ¤– Model Preferences</h3>
        <canvas id="modelChart"></canvas>
      </div>

      <div class="chart-card">
        <h3>âš¡ AWOL Frequency by Hour</h3>
        <canvas id="awolTimeChart"></canvas>
      </div>

      <div class="chart-card">
        <h3>ðŸ˜† Funniness Distribution</h3>
        <canvas id="funninessChart"></canvas>
      </div>
    </div>

    <!-- Recent AWOL Events -->
    <div class="awol-events">
      <h3>ðŸ”¥ Recent AWOL Events (Bots Gone Wild)</h3>
      <div id="awolEventsList"></div>
    </div>

    <!-- Funny Moments -->
    <div class="funny-moments">
      <h3>ðŸ˜‚ Top Funny Moments</h3>
      <div id="funnyMomentsList"></div>
    </div>

    <button class="refresh-btn" onclick="loadAllData()">ðŸ”„ Refresh Data</button>
  </div>

  <script>
    let brandChart, modelChart, awolTimeChart, funninessChart;

    // Load all analytics data
    async function loadAllData() {
      try {
        await Promise.all([
          loadBrandEngagement(),
          loadModelPreferences(),
          loadAWOLEvents(),
          loadFunnyMoments(),
          loadStats()
        ]);
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    // Load brand engagement
    async function loadBrandEngagement() {
      try {
        const response = await fetch('/api/analytics/brands');
        const data = await response.json();

        if (!data.success || !data.brands) return;

        const brands = Object.keys(data.brands);
        const interactions = brands.map(b => data.brands[b].interactions || 0);
        const uniqueUsers = brands.map(b => data.brands[b].uniqueUsers || 0);

        if (brandChart) brandChart.destroy();

        const ctx = document.getElementById('brandChart').getContext('2d');
        brandChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: brands,
            datasets: [
              {
                label: 'Interactions',
                data: interactions,
                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 2
              },
              {
                label: 'Unique Users',
                data: uniqueUsers,
                backgroundColor: 'rgba(118, 75, 162, 0.8)',
                borderColor: 'rgba(118, 75, 162, 1)',
                borderWidth: 2
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: true
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      } catch (error) {
        console.error('Error loading brand engagement:', error);
      }
    }

    // Load model preferences
    async function loadModelPreferences() {
      try {
        const response = await fetch('/api/analytics/models');
        const data = await response.json();

        if (!data.success || !data.models) return;

        const models = Object.keys(data.models);
        const usage = models.map(m => data.models[m] || 0);

        if (modelChart) modelChart.destroy();

        const ctx = document.getElementById('modelChart').getContext('2d');
        modelChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: models,
            datasets: [{
              data: usage,
              backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)'
              ]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      } catch (error) {
        console.error('Error loading model preferences:', error);
      }
    }

    // Load AWOL events
    async function loadAWOLEvents() {
      try {
        const response = await fetch('/api/analytics/awol-events');
        const data = await response.json();

        if (!data.success || !data.events) return;

        const eventsList = document.getElementById('awolEventsList');
        eventsList.innerHTML = data.events.length === 0
          ? '<p style="color: #666;">No AWOL events yet. Bots are behaving!</p>'
          : data.events.slice(0, 5).map(event => `
            <div class="awol-event">
              <div class="bot-name">ðŸ¤– ${event.bot_name || 'Unknown Bot'} (${event.platform})</div>
              <div class="message">"${event.message}"</div>
              <div class="metadata">
                <strong>Trigger:</strong> ${event.trigger || 'Unknown'} |
                <strong>Switch:</strong> ${event.previous_personality} â†’ ${event.new_personality} |
                <strong>When:</strong> ${new Date(event.created_at).toLocaleString()}
              </div>
            </div>
          `).join('');

        // Simple hourly distribution for demo
        const hours = new Array(24).fill(0);
        data.events.forEach(event => {
          const hour = new Date(event.created_at).getHours();
          hours[hour]++;
        });

        if (awolTimeChart) awolTimeChart.destroy();

        const ctx = document.getElementById('awolTimeChart').getContext('2d');
        awolTimeChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
              label: 'AWOL Events',
              data: hours,
              borderColor: 'rgba(255, 107, 107, 1)',
              backgroundColor: 'rgba(255, 107, 107, 0.2)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      } catch (error) {
        console.error('Error loading AWOL events:', error);
      }
    }

    // Load funny moments
    async function loadFunnyMoments() {
      try {
        const response = await fetch('/api/analytics/funny-moments');
        const data = await response.json();

        if (!data.success || !data.moments) return;

        const momentsList = document.getElementById('funnyMomentsList');
        momentsList.innerHTML = data.moments.length === 0
          ? '<p style="color: #666;">No funny moments logged yet!</p>'
          : data.moments.slice(0, 5).map(moment => `
            <div class="funny-moment">
              <div class="brand">Brand: ${moment.brand}</div>
              <div class="message">${moment.message}</div>
              <div>
                <span class="funniness-score">ðŸ˜‚ ${moment.funniness}/10</span>
                <span style="margin-left: 10px; color: #666; font-size: 0.85rem;">
                  ${new Date(moment.created_at).toLocaleString()}
                </span>
              </div>
            </div>
          `).join('');

        // Funniness distribution
        const funninessDistribution = new Array(11).fill(0);
        data.moments.forEach(moment => {
          funninessDistribution[moment.funniness]++;
        });

        if (funninessChart) funninessChart.destroy();

        const ctx = document.getElementById('funninessChart').getContext('2d');
        funninessChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
            datasets: [{
              label: 'Funny Moments',
              data: funninessDistribution,
              backgroundColor: 'rgba(255, 193, 7, 0.8)',
              borderColor: 'rgba(255, 193, 7, 1)',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      } catch (error) {
        console.error('Error loading funny moments:', error);
      }
    }

    // Load summary stats
    async function loadStats() {
      try {
        const [brands, awol, funny, models] = await Promise.all([
          fetch('/api/analytics/brands').then(r => r.json()),
          fetch('/api/analytics/awol-events').then(r => r.json()),
          fetch('/api/analytics/funny-moments').then(r => r.json()),
          fetch('/api/analytics/models').then(r => r.json())
        ]);

        document.getElementById('totalBrands').textContent =
          brands.success ? Object.keys(brands.brands || {}).length : 0;

        document.getElementById('totalAwol').textContent =
          awol.success ? (awol.events || []).length : 0;

        document.getElementById('totalFunny').textContent =
          funny.success ? (funny.moments || []).length : 0;

        document.getElementById('totalModels').textContent =
          models.success ? Object.keys(models.models || {}).length : 0;

      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Auto-refresh every 30 seconds
    setInterval(loadAllData, 30000);

    // Initial load
    loadAllData();
  </script>
</body>
</html>
