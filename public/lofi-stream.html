<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CalOS Lofi Radio üìª</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 3em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .stat {
      background: rgba(255,255,255,0.1);
      padding: 15px 30px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.8;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
      margin-top: 30px;
    }

    .player-section {
      background: rgba(255,255,255,0.1);
      padding: 30px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .now-playing {
      text-align: center;
      margin-bottom: 30px;
    }

    .album-art {
      width: 300px;
      height: 300px;
      margin: 0 auto 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 6em;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }

    .song-info {
      margin-bottom: 20px;
    }

    .song-title {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .song-artist {
      font-size: 1.2em;
      opacity: 0.8;
    }

    .player-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
    }

    .control-btn {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      color: #fff;
      padding: 15px 25px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.3s;
    }

    .control-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .panel-title {
      font-size: 1.5em;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }

    .queue-item {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }

    .queue-item:hover {
      background: rgba(255,255,255,0.2);
      transform: translateX(5px);
    }

    .queue-position {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 5px;
      margin-right: 10px;
      font-weight: bold;
    }

    .request-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    label {
      font-size: 0.9em;
      opacity: 0.9;
    }

    input, textarea {
      padding: 12px;
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-family: inherit;
      font-size: 1em;
    }

    input::placeholder, textarea::placeholder {
      color: rgba(255,255,255,0.5);
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.15);
    }

    .btn-request {
      background: #10b981;
      border: none;
      color: #fff;
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    .btn-request:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.3);
    }

    .btn-request:disabled {
      background: #6b7280;
      cursor: not-allowed;
      transform: none;
    }

    .message {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      animation: slideIn 0.3s ease;
    }

    .message.success {
      background: rgba(16, 185, 129, 0.2);
      border: 2px solid #10b981;
    }

    .message.error {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #ef4444;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 0.8em;
      margin-left: 5px;
    }

    .badge.pending {
      background: #f59e0b;
    }

    .badge.approved {
      background: #10b981;
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      .album-art {
        width: 200px;
        height: 200px;
      }

      h1 {
        font-size: 2em;
      }
    }

    @media (max-width: 640px) {
      .stats-bar {
        flex-direction: column;
        gap: 10px;
      }

      .stat {
        width: 100%;
      }

      .control-btn {
        padding: 10px 15px;
        font-size: 1em;
      }
    }

    /* Heatmap overlay */
    #heatmap-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      opacity: 0.3;
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.5em;
      opacity: 0.7;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <canvas id="heatmap-canvas"></canvas>

  <div class="container">
    <header>
      <h1>üìª CalOS Lofi Radio</h1>
      <div class="subtitle">chill beats to code/relax to</div>
    </header>

    <div class="stats-bar">
      <div class="stat" style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.3);">
        <div class="stat-value" id="active-viewers">--</div>
        <div class="stat-label">üëÅÔ∏è watching now</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="total-sessions">--</div>
        <div class="stat-label">üìä total sessions</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="peak-viewers">--</div>
        <div class="stat-label">üî• peak viewers</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="queue-count">--</div>
        <div class="stat-label">üéµ in queue</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="session-duration">0:00</div>
        <div class="stat-label">‚è±Ô∏è your session</div>
      </div>
    </div>

    <div class="main-content">
      <div class="player-section">
        <div class="now-playing">
          <div class="album-art">
            <span>üéß</span>
          </div>
          <div class="song-info">
            <div class="song-title" id="song-title">Loading...</div>
            <div class="song-artist" id="song-artist">CalOS Radio</div>
          </div>
        </div>

        <div class="player-controls">
          <button class="control-btn" onclick="skipSong()">‚è≠Ô∏è Skip</button>
          <button class="control-btn" onclick="toggleMute()">üîä Mute</button>
          <button class="control-btn" onclick="shareStream()">üîó Share</button>
        </div>
      </div>

      <div class="sidebar">
        <div class="panel">
          <div class="panel-title">üéµ Song Queue</div>
          <div id="queue-container">
            <div class="loading pulse">Loading queue...</div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">‚ûï Request a Song</div>
          <div id="badge-status" style="padding: 10px; margin-bottom: 10px; border-radius: 10px; background: rgba(255,255,255,0.1); font-size: 0.9em;">
            <div style="opacity: 0.7;">Loading badge status...</div>
          </div>
          <div id="message-container"></div>
          <form class="request-form" onsubmit="requestSong(event)">
            <div class="form-group">
              <label>Song Title *</label>
              <input type="text" id="song-title-input" placeholder="Enter song title..." required>
            </div>
            <div class="form-group">
              <label>Artist</label>
              <input type="text" id="song-artist-input" placeholder="Enter artist name...">
            </div>
            <div class="form-group">
              <label>YouTube/Spotify URL</label>
              <input type="url" id="song-url-input" placeholder="https://...">
            </div>
            <div class="form-group">
              <label>Message (optional)</label>
              <textarea id="song-message-input" rows="2" placeholder="Any special message?"></textarea>
            </div>
            <button type="submit" class="btn-request" id="submit-btn">üéµ Request Song</button>
          </form>
        </div>

        <div class="panel">
          <div class="panel-title">üí¨ Lofi Assistant</div>
          <div class="chat-container" id="chat-container" style="height: 300px; overflow-y: auto; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px;">
            <div style="text-align: center; opacity: 0.6; padding: 20px;">
              Ask me about songs, artists, or get recommendations!
            </div>
          </div>
          <form class="request-form" onsubmit="sendChatMessage(event)" style="flex-direction: row; gap: 5px;">
            <input type="text" id="chat-input" placeholder="Ask anything..." style="flex: 1;" autocomplete="off">
            <button type="submit" style="padding: 12px 20px; background: #667eea; border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: bold;">Send</button>
          </form>
          <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.7;">
            <strong>Commands:</strong> /recommend, /lookup [artist], /stats, /help
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/lib/heatmap-tracker.js"></script>
  <script>
    // Configuration
    const WS_URL = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const WS_HOST = window.location.host;
    const ROOM_NAME = 'lofi-stream';

    // State
    let ws = null;
    let deviceId = null;
    let sessionId = null;
    let sessionStartTime = Date.now();
    let heatmapTracker = null;

    // Initialize
    (async function init() {
      // Get or generate device ID
      deviceId = localStorage.getItem('lofi_device_id');
      if (!deviceId) {
        deviceId = await generateDeviceFingerprint();
        localStorage.setItem('lofi_device_id', deviceId);
      }

      // Initialize heatmap tracker
      if (typeof HeatmapTracker !== 'undefined') {
        heatmapTracker = new HeatmapTracker({
          deviceId,
          page: 'lofi-stream',
          roomName: ROOM_NAME,
          apiEndpoint: '/api/lofi/track-heatmap'
        });
      }

      // Connect to WebSocket
      connectWebSocket();

      // Load initial data
      loadRoomState();
      loadQueue();
      loadBadgeStatus();

      // Update session duration every second
      setInterval(updateSessionDuration, 1000);

      // Send heartbeat every 30 seconds
      setInterval(sendHeartbeat, 30000);
    })();

    /**
     * Generate device fingerprint
     */
    async function generateDeviceFingerprint() {
      const components = [
        navigator.userAgent,
        screen.width + 'x' + screen.height,
        navigator.hardwareConcurrency || 'unknown',
        new Date().getTimezoneOffset(),
        navigator.language
      ];

      // Canvas fingerprint
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('CalOS Lofi üéß', 2, 2);
      components.push(canvas.toDataURL());

      const combined = components.join('|');
      const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(combined));
      return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('')
        .slice(0, 64);
    }

    /**
     * Connect to WebSocket
     */
    function connectWebSocket() {
      ws = new WebSocket(`${WS_URL}${WS_HOST}`);

      ws.onopen = () => {
        console.log('‚úì Connected to CalOS Radio');

        // Start session
        ws.send(JSON.stringify({
          type: 'start_session',
          deviceId,
          page: 'lofi-stream',
          userAgent: navigator.userAgent,
          referrer: document.referrer
        }));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
      };

      ws.onclose = () => {
        console.log('‚úó Disconnected from CalOS Radio');
        setTimeout(connectWebSocket, 3000); // Reconnect after 3s
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
    }

    /**
     * Handle WebSocket messages
     */
    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'session_started':
          sessionId = data.sessionId;
          console.log('Session started:', sessionId);

          // Join room
          ws.send(JSON.stringify({
            type: 'join_room',
            room: ROOM_NAME
          }));

          // Initialize heatmap tracking with session ID
          if (heatmapTracker) {
            heatmapTracker.sessionId = sessionId;
            heatmapTracker.start();
          }
          break;

        case 'room_joined':
          console.log('Joined room:', data.room);
          break;

        case 'room_viewers':
          if (data.room === ROOM_NAME) {
            document.getElementById('active-viewers').textContent = data.count;
            // Reload full room state to get updated totals
            loadRoomState();
          }
          break;

        case 'song_requested':
          if (data.roomName === ROOM_NAME) {
            showMessage('New song requested: ' + data.request.songTitle, 'success');
            loadQueue();
          }
          break;

        case 'now_playing':
          if (data.roomName === ROOM_NAME) {
            updateNowPlaying(data.song);
          }
          break;

        case 'song_moderated':
          loadQueue();
          break;
      }
    }

    /**
     * Load room state
     */
    async function loadRoomState() {
      try {
        const response = await fetch(`/api/lofi/room-state?room=${ROOM_NAME}`);
        const data = await response.json();

        if (data.status === 'success') {
          document.getElementById('active-viewers').textContent = data.room.viewers;
          document.getElementById('total-sessions').textContent = data.room.totalSessions;
          document.getElementById('peak-viewers').textContent = data.room.peakViewers;

          if (data.room.nowPlaying) {
            updateNowPlaying(data.room.nowPlaying);
          }
        }
      } catch (error) {
        console.error('Error loading room state:', error);
      }
    }

    /**
     * Load badge status
     */
    async function loadBadgeStatus() {
      try {
        // Fetch device info from user_devices table
        const response = await fetch(`/api/elo/device-stats?deviceId=${deviceId}`);
        const data = await response.json();

        const badgeContainer = document.getElementById('badge-status');

        if (data.status === 'success' && data.device) {
          const device = data.device;
          const badge = device.current_badge || 'newcomer';
          const trustScore = (device.trust_score * 100).toFixed(0);
          const votes = device.total_votes || 0;

          // Badge emoji mapping
          const badgeEmojis = {
            newcomer: 'üë§',
            email_verified: '‚úâÔ∏è',
            contributor: '‚úì',
            trusted_voter: '‚úì‚úì',
            veteran: '‚≠ê',
            legend: 'üëë',
            moderator: 'üõ°Ô∏è'
          };

          const emoji = badgeEmojis[badge] || 'üë§';

          let statusHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="font-size: 2em;">${emoji}</div>
              <div style="flex: 1;">
                <div style="font-weight: bold; text-transform: capitalize;">${badge.replace('_', ' ')}</div>
                <div style="opacity: 0.7; font-size: 0.85em;">Trust: ${trustScore}% ‚Ä¢ ${votes} votes</div>
              </div>
            </div>
          `;

          // Check if can request songs
          if (badge === 'newcomer' && votes < 10) {
            statusHTML += `
              <div style="margin-top: 10px; padding: 10px; background: rgba(245, 158, 11, 0.2); border-radius: 5px; border: 1px solid rgba(245, 158, 11, 0.5);">
                <strong>‚ö†Ô∏è Permission Required</strong><br>
                <small>You need <strong>Contributor</strong> badge to request songs.<br>
                Vote on ${10 - votes} more items in the <a href="/swiper-cooking-elo.html" style="color: #fff;">ELO system</a> to unlock!</small>
              </div>
            `;

            // Disable submit button
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('submit-btn').textContent = 'üîí Locked - Need Contributor Badge';
          } else {
            statusHTML += `
              <div style="margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.2); border-radius: 5px; border: 1px solid rgba(16, 185, 129, 0.5);">
                <strong>‚úì Song Requests Enabled</strong><br>
                <small>You can request up to 3 songs per hour</small>
              </div>
            `;
          }

          badgeContainer.innerHTML = statusHTML;

        } else {
          // New device - show newcomer status
          badgeContainer.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="font-size: 2em;">üë§</div>
              <div style="flex: 1;">
                <div style="font-weight: bold;">Newcomer</div>
                <div style="opacity: 0.7; font-size: 0.85em;">New to the community</div>
              </div>
            </div>
            <div style="margin-top: 10px; padding: 10px; background: rgba(245, 158, 11, 0.2); border-radius: 5px; border: 1px solid rgba(245, 158, 11, 0.5);">
              <strong>‚ö†Ô∏è Permission Required</strong><br>
              <small>You need <strong>Contributor</strong> badge to request songs.<br>
              Vote on at least 10 items in the <a href="/swiper-cooking-elo.html" style="color: #fff;">ELO system</a> to unlock!</small>
            </div>
          `;

          // Disable submit button
          document.getElementById('submit-btn').disabled = true;
          document.getElementById('submit-btn').textContent = 'üîí Locked - Need Contributor Badge';
        }

      } catch (error) {
        console.error('Error loading badge status:', error);
        document.getElementById('badge-status').innerHTML = `
          <div style="opacity: 0.7;">Unable to load badge status</div>
        `;
      }
    }

    /**
     * Load song queue
     */
    async function loadQueue() {
      try {
        const response = await fetch('/api/lofi/queue');
        const data = await response.json();

        if (data.status === 'success') {
          document.getElementById('queue-count').textContent = data.queue.length;

          const container = document.getElementById('queue-container');
          if (data.queue.length === 0) {
            container.innerHTML = '<div style="opacity: 0.6; text-align: center; padding: 20px;">Queue is empty. Be the first to request!</div>';
          } else {
            container.innerHTML = data.queue.map((item, index) => `
              <div class="queue-item">
                <span class="queue-position">#${item.queue_position || index + 1}</span>
                <div style="display: inline-block;">
                  <strong>${item.song_title}</strong>
                  ${item.song_artist ? `<br><small>${item.song_artist}</small>` : ''}
                  <span class="badge ${item.status}">${item.status}</span>
                </div>
              </div>
            `).join('');
          }
        }
      } catch (error) {
        console.error('Error loading queue:', error);
      }
    }

    /**
     * Request a song
     */
    async function requestSong(event) {
      event.preventDefault();

      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const response = await fetch('/api/lofi/request-song', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            deviceId,
            songTitle: document.getElementById('song-title-input').value,
            songArtist: document.getElementById('song-artist-input').value,
            songUrl: document.getElementById('song-url-input').value,
            message: document.getElementById('song-message-input').value
          })
        });

        const data = await response.json();

        if (data.status === 'success') {
          showMessage('‚úì Song requested! Position #' + data.request.queuePosition, 'success');

          // Clear form
          document.getElementById('song-title-input').value = '';
          document.getElementById('song-artist-input').value = '';
          document.getElementById('song-url-input').value = '';
          document.getElementById('song-message-input').value = '';

          // Reload queue
          loadQueue();
        } else {
          showMessage('‚úó ' + (data.message || 'Request failed'), 'error');
        }
      } catch (error) {
        showMessage('‚úó Network error: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'üéµ Request Song';
      }
    }

    /**
     * Update now playing
     */
    function updateNowPlaying(song) {
      document.getElementById('song-title').textContent = song.title;
      document.getElementById('song-artist').textContent = song.artist || 'Unknown Artist';
    }

    /**
     * Show message
     */
    function showMessage(text, type) {
      const container = document.getElementById('message-container');
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.textContent = text;
      container.appendChild(msg);

      setTimeout(() => msg.remove(), 5000);
    }

    /**
     * Update session duration
     */
    function updateSessionDuration() {
      const duration = Math.floor((Date.now() - sessionStartTime) / 1000);
      const minutes = Math.floor(duration / 60);
      const seconds = duration % 60;
      document.getElementById('session-duration').textContent =
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    /**
     * Send heartbeat
     */
    function sendHeartbeat() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'heartbeat' }));
      }
    }

    /**
     * Player controls
     */
    function skipSong() {
      showMessage('Skip voting not yet implemented', 'error');
    }

    function toggleMute() {
      showMessage('Audio player not yet implemented', 'error');
    }

    function shareStream() {
      const url = window.location.href;
      if (navigator.share) {
        navigator.share({
          title: 'CalOS Lofi Radio',
          text: 'Join me listening to lofi beats!',
          url
        });
      } else {
        navigator.clipboard.writeText(url);
        showMessage('‚úì Link copied to clipboard!', 'success');
      }
    }

    /**
     * Send chat message
     */
    async function sendChatMessage(event) {
      event.preventDefault();

      const input = document.getElementById('chat-input');
      const message = input.value.trim();

      if (!message) return;

      // Clear input
      input.value = '';

      // Add user message to chat
      addChatMessage('You', message, 'user');

      // Check if it's a command
      if (message.startsWith('/')) {
        handleCommand(message);
        return;
      }

      // Send to agent via API
      try {
        const response = await fetch('/api/lofi/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            deviceId,
            roomName: ROOM_NAME,
            message,
            agent: 'gpt-3.5' // Default to GPT-3.5 for speed
          })
        });

        const data = await response.json();

        if (data.status === 'success') {
          addChatMessage('Assistant', data.response, 'assistant');
        } else {
          addChatMessage('System', 'Error: ' + (data.message || 'Request failed'), 'error');
        }
      } catch (error) {
        addChatMessage('System', 'Network error: ' + error.message, 'error');
      }
    }

    /**
     * Add message to chat
     */
    function addChatMessage(sender, message, type = 'user') {
      const container = document.getElementById('chat-container');

      // Remove welcome message if present
      if (container.children.length === 1 && container.children[0].textContent.includes('Ask me about')) {
        container.innerHTML = '';
      }

      const msgDiv = document.createElement('div');
      msgDiv.style.cssText = `
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 10px;
        ${type === 'user' ? 'background: rgba(102, 126, 234, 0.2); text-align: right;' : ''}
        ${type === 'assistant' ? 'background: rgba(118, 75, 162, 0.2);' : ''}
        ${type === 'error' ? 'background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5);' : ''}
        animation: slideIn 0.3s ease;
      `;

      const senderSpan = document.createElement('div');
      senderSpan.style.cssText = 'font-weight: bold; margin-bottom: 5px; font-size: 0.9em; opacity: 0.8;';
      senderSpan.textContent = sender;

      const messageSpan = document.createElement('div');
      messageSpan.textContent = message;

      msgDiv.appendChild(senderSpan);
      msgDiv.appendChild(messageSpan);
      container.appendChild(msgDiv);

      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    /**
     * Handle slash commands
     */
    async function handleCommand(command) {
      const parts = command.split(' ');
      const cmd = parts[0].toLowerCase();

      switch (cmd) {
        case '/help':
          addChatMessage('System', `Available commands:
‚Ä¢ /recommend - Get song recommendations
‚Ä¢ /lookup [artist] - Look up artist info
‚Ä¢ /stats - View room statistics
‚Ä¢ /help - Show this help`, 'assistant');
          break;

        case '/stats':
          try {
            const response = await fetch(`/api/lofi/room-state?room=${ROOM_NAME}`);
            const data = await response.json();
            if (data.status === 'success') {
              addChatMessage('System', `Room Stats:
‚Ä¢ ${data.room.viewers} active viewers
‚Ä¢ ${data.room.totalSessions} total sessions
‚Ä¢ ${data.room.peakViewers} peak viewers
‚Ä¢ ${data.room.queueLength} songs in queue`, 'assistant');
            }
          } catch (error) {
            addChatMessage('System', 'Failed to fetch stats', 'error');
          }
          break;

        case '/recommend':
          addChatMessage('Assistant', 'Generating lofi recommendations based on current vibe...', 'assistant');
          // Call agent for recommendations
          setTimeout(() => {
            addChatMessage('Assistant', `Here are some chill lofi tracks:
‚Ä¢ "Coffee Shop Dreams" - LoFi Girl
‚Ä¢ "Rainy Day Study" - Chillhop Music
‚Ä¢ "Late Night Vibes" - Homework Radio
‚Ä¢ "Tokyo Sunset" - Beats to Relax`, 'assistant');
          }, 1000);
          break;

        case '/lookup':
          const artist = parts.slice(1).join(' ');
          if (!artist) {
            addChatMessage('System', 'Usage: /lookup [artist name]', 'error');
            return;
          }
          addChatMessage('Assistant', `Looking up "${artist}"...`, 'assistant');
          // Would call music API here
          setTimeout(() => {
            addChatMessage('Assistant', `Artist info for "${artist}" - This would integrate with a music database API for real artist information.`, 'assistant');
          }, 1000);
          break;

        default:
          addChatMessage('System', `Unknown command: ${cmd}. Type /help for available commands.`, 'error');
      }
    }

    /**
     * Cleanup on page unload
     */
    window.addEventListener('beforeunload', () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'leave_room',
          room: ROOM_NAME
        }));
      }
    });
  </script>
</body>
</html>
