<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CalOS API Key Verifier</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #4a9eff;
      font-size: 32px;
    }
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
    }
    .input-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #aaa;
      font-size: 14px;
      font-weight: 500;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #4a9eff;
      box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2);
    }
    .btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #4a9eff 0%, #357abd 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 158, 255, 0.4);
    }
    .btn:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: linear-gradient(135deg, #6a6a6a 0%, #4a4a4a 100%);
      margin-left: 10px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-active { background: #2ecc71; color: white; }
    .status-inactive { background: #e74c3c; color: white; }
    .status-expired { background: #f39c12; color: white; }
    .result-section {
      display: none;
      margin-top: 20px;
    }
    .result-section.show {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .metric {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .metric:last-child {
      border-bottom: none;
    }
    .metric-label {
      color: #aaa;
      font-size: 14px;
    }
    .metric-value {
      color: #fff;
      font-weight: 600;
      font-size: 14px;
    }
    .metric-value.large {
      font-size: 24px;
      color: #4a9eff;
    }
    .test-log {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 8px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #0f0;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .error {
      background: rgba(231, 76, 60, 0.1);
      border-left: 4px solid #e74c3c;
      padding: 12px;
      border-radius: 4px;
      margin-top: 12px;
      color: #e74c3c;
    }
    .success {
      background: rgba(46, 204, 113, 0.1);
      border-left: 4px solid #2ecc71;
      padding: 12px;
      border-radius: 4px;
      margin-top: 12px;
      color: #2ecc71;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.03);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .stat-label {
      color: #888;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #4a9eff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔑 API Key Verifier</h1>
    <p class="subtitle">Verify CalOS platform API keys, check credits, and test live requests</p>

    <div class="card">
      <div class="input-group">
        <label for="apiKey">API Key</label>
        <input type="text" id="apiKey" placeholder="sk-tenant-XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX-XXXX" />
      </div>

      <button class="btn" id="verifyBtn" onclick="verifyKey()">Verify Key</button>
      <button class="btn btn-secondary" id="testBtn" onclick="testKey()" disabled>Test Live Request</button>
    </div>

    <div id="resultSection" class="result-section">
      <div class="card">
        <h2 style="margin-bottom: 20px; color: #4a9eff;">Key Information</h2>
        <div class="metric">
          <span class="metric-label">Status</span>
          <span class="metric-value" id="keyStatus"></span>
        </div>
        <div class="metric">
          <span class="metric-label">Key Name</span>
          <span class="metric-value" id="keyName"></span>
        </div>
        <div class="metric">
          <span class="metric-label">Tenant ID</span>
          <span class="metric-value" id="tenantId"></span>
        </div>
        <div class="metric">
          <span class="metric-label">Created</span>
          <span class="metric-value" id="createdAt"></span>
        </div>
        <div class="metric">
          <span class="metric-label">Last Used</span>
          <span class="metric-value" id="lastUsed"></span>
        </div>
      </div>

      <div class="grid">
        <div class="stat-card">
          <div class="stat-label">Credits Remaining</div>
          <div class="stat-value" id="creditsRemaining">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Rate Limit (per min)</div>
          <div class="stat-value" id="rateLimit">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Requests Today</div>
          <div class="stat-value" id="requestsToday">--</div>
        </div>
      </div>

      <div class="card" id="testResultCard" style="display: none; margin-top: 20px;">
        <h2 style="margin-bottom: 16px; color: #4a9eff;">Test Result</h2>
        <div class="test-log" id="testLog"></div>
      </div>
    </div>

    <div id="errorMsg"></div>
  </div>

  <script>
    const backendUrl = 'http://localhost:5001';
    let currentKey = null;
    let userContext = null;

    // Load user context on page load (double contingency auth)
    async function loadUserContext() {
      try {
        const response = await fetch(`${backendUrl}/api/schema-dashboard/context`, {
          headers: {
            'X-User-Id': 'e7dc083f-61de-4567-a5b6-b21ddb09cb2d' // Dev: hardcoded roughsparks
          }
        });
        if (response.ok) {
          const result = await response.json();
          userContext = result.data;
          console.log('[KeyVerifier] User context loaded:', userContext.username, userContext.email);
        }
      } catch (error) {
        console.error('[KeyVerifier] Failed to load user context:', error);
      }
    }

    // Load context on page load
    loadUserContext();

    async function verifyKey() {
      const apiKey = document.getElementById('apiKey').value.trim();

      if (!apiKey) {
        showError('Please enter an API key');
        return;
      }

      if (!apiKey.startsWith('sk-tenant-')) {
        showError('Invalid key format. Must start with sk-tenant-');
        return;
      }

      const verifyBtn = document.getElementById('verifyBtn');
      const testBtn = document.getElementById('testBtn');
      verifyBtn.disabled = true;
      verifyBtn.textContent = 'Verifying...';

      try {
        // Extract tenant ID from key
        const parts = apiKey.split('-');
        const tenantId = parts[2];

        // Get key info from database (using user context if available)
        const response = await fetch(`${backendUrl}/api/keys`, {
          headers: {
            'X-User-Id': userContext?.user_id || 'e7dc083f-61de-4567-a5b6-b21ddb09cb2d'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to fetch key info');
        }

        const data = await response.json();
        // Match by key prefix + last 4 digits
        const keyInfo = data.data?.keys.find(k =>
          apiKey.startsWith(k.key_prefix) && apiKey.endsWith(k.key_suffix_last4)
        );

        if (!keyInfo) {
          throw new Error('Key not found');
        }

        // Get credits info (from context or API)
        let credits = userContext?.credits_remaining || 0;
        if (!userContext) {
          const creditsResponse = await fetch(`${backendUrl}/api/auth/me`, {
            headers: {
              'X-User-Id': 'e7dc083f-61de-4567-a5b6-b21ddb09cb2d'
            }
          });
          if (creditsResponse.ok) {
            const creditsData = await creditsResponse.json();
            credits = creditsData.credits_remaining || 0;
          }
        }

        // Display results
        currentKey = apiKey;
        document.getElementById('keyStatus').innerHTML = `<span class="status-badge status-${keyInfo.status}">${keyInfo.status}</span>`;
        document.getElementById('keyName').textContent = keyInfo.key_name;
        document.getElementById('tenantId').textContent = tenantId;
        document.getElementById('createdAt').textContent = new Date(keyInfo.created_at).toLocaleString();
        document.getElementById('lastUsed').textContent = keyInfo.last_used_at ? new Date(keyInfo.last_used_at).toLocaleString() : 'Never';
        document.getElementById('creditsRemaining').textContent = credits.toLocaleString();
        document.getElementById('rateLimit').textContent = keyInfo.rate_limit_rps || 60;
        document.getElementById('requestsToday').textContent = keyInfo.usage_count || 0;

        document.getElementById('resultSection').classList.add('show');
        testBtn.disabled = keyInfo.status !== 'active';

        showSuccess('Key verified successfully!');

      } catch (error) {
        showError(error.message);
      } finally {
        verifyBtn.disabled = false;
        verifyBtn.textContent = 'Verify Key';
      }
    }

    async function testKey() {
      if (!currentKey) {
        showError('Please verify a key first');
        return;
      }

      const testBtn = document.getElementById('testBtn');
      testBtn.disabled = true;
      testBtn.textContent = 'Testing...';

      const testLog = document.getElementById('testLog');
      const testResultCard = document.getElementById('testResultCard');
      testResultCard.style.display = 'block';
      testLog.textContent = 'Sending test request to Ollama...\n';

      try {
        const response = await fetch(`${backendUrl}/api/ollama/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentKey}`
          },
          body: JSON.stringify({
            model: 'llama3.2:3b',
            prompt: 'Say hello in exactly 5 words'
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Request failed');
        }

        testLog.textContent += `\n✅ Status: ${response.status}\n`;
        testLog.textContent += `📦 Response:\n${JSON.stringify(data, null, 2)}\n`;
        testLog.textContent += `\n💬 AI Response: ${data.response || data.content}\n`;
        testLog.textContent += `\n✨ Test successful! Key is working.`;

        showSuccess('Test request completed successfully!');

      } catch (error) {
        testLog.textContent += `\n❌ Error: ${error.message}`;
        showError(`Test failed: ${error.message}`);
      } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'Test Live Request';
      }
    }

    function showError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.innerHTML = `<div class="error">❌ ${message}</div>`;
      setTimeout(() => errorMsg.innerHTML = '', 5000);
    }

    function showSuccess(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.innerHTML = `<div class="success">✅ ${message}</div>`;
      setTimeout(() => errorMsg.innerHTML = '', 5000);
    }
  </script>
</body>
</html>
