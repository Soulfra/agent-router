<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CalOS Verification Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      text-align: center;
    }

    h1 {
      font-size: 2.5rem;
      color: #667eea;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 1.1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 1.3rem;
      color: #667eea;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-ok {
      background: #10b981;
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    .status-warning {
      background: #f59e0b;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
    }

    .status-error {
      background: #ef4444;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
    }

    .status-unknown {
      background: #6b7280;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .metric:last-child {
      border-bottom: none;
    }

    .metric-label {
      color: #666;
      font-size: 0.95rem;
    }

    .metric-value {
      font-weight: 600;
      color: #333;
      font-size: 1.1rem;
    }

    .metric-value.good {
      color: #10b981;
    }

    .metric-value.warning {
      color: #f59e0b;
    }

    .metric-value.bad {
      color: #ef4444;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #666;
      border-bottom: 2px solid #e0e0e0;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .badge-green {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-yellow {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-red {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-gray {
      background: #f3f4f6;
      color: #374151;
    }

    .last-update {
      text-align: center;
      color: white;
      margin-top: 20px;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }

    .big-stat {
      text-align: center;
      padding: 20px 0;
    }

    .big-stat-value {
      font-size: 3rem;
      font-weight: 700;
      color: #667eea;
      line-height: 1;
    }

    .big-stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 1.8rem;
      }

      .big-stat-value {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üß™ CalOS Verification Dashboard</h1>
      <p class="subtitle">Real-time system health and performance monitoring</p>
    </header>

    <div class="grid">
      <!-- System Status -->
      <div class="card">
        <h2>
          <span class="status-indicator" id="system-status"></span>
          System Status
        </h2>
        <div class="metric">
          <span class="metric-label">Router</span>
          <span class="metric-value" id="router-status">Checking...</span>
        </div>
        <div class="metric">
          <span class="metric-label">Ollama</span>
          <span class="metric-value" id="ollama-status">Checking...</span>
        </div>
        <div class="metric">
          <span class="metric-label">Database</span>
          <span class="metric-value" id="database-status">Checking...</span>
        </div>
      </div>

      <!-- Overall Stats -->
      <div class="card">
        <h2>üìä Overall Statistics</h2>
        <div class="metric">
          <span class="metric-label">Total Queries</span>
          <span class="metric-value" id="total-queries">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">With Timing Data</span>
          <span class="metric-value" id="queries-with-timing">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Cache Hits</span>
          <span class="metric-value" id="cache-hits">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Cache Hit Rate</span>
          <span class="metric-value" id="cache-hit-rate">-</span>
        </div>
      </div>

      <!-- Average Latency -->
      <div class="card">
        <h2>‚ö° Average Latency</h2>
        <div class="big-stat">
          <div class="big-stat-value" id="avg-latency">-</div>
          <div class="big-stat-label">milliseconds</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Latency Breakdown -->
      <div class="card">
        <h2>‚è±Ô∏è Latency Breakdown</h2>
        <div class="metric">
          <span class="metric-label">Minimum</span>
          <span class="metric-value good" id="min-latency">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Average</span>
          <span class="metric-value" id="avg-latency-2">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">P50 (Median)</span>
          <span class="metric-value" id="p50-latency">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">P95</span>
          <span class="metric-value warning" id="p95-latency">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">P99</span>
          <span class="metric-value warning" id="p99-latency">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Maximum</span>
          <span class="metric-value bad" id="max-latency">-</span>
        </div>
      </div>

      <!-- Cache Performance -->
      <div class="card">
        <h2>üíæ Cache Performance</h2>
        <div class="metric">
          <span class="metric-label">Cache Hit Latency</span>
          <span class="metric-value good" id="cache-hit-latency">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Cache Miss Latency</span>
          <span class="metric-value" id="cache-miss-latency">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Speedup Factor</span>
          <span class="metric-value" id="speedup-factor">-</span>
        </div>
      </div>

      <!-- Response Categories -->
      <div class="card">
        <h2>üìà Response Categories</h2>
        <div class="metric">
          <span class="metric-label">Fast (< 100ms)</span>
          <span class="metric-value good" id="fast-responses">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Normal (100ms - 5s)</span>
          <span class="metric-value" id="normal-responses">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Slow (> 5s)</span>
          <span class="metric-value bad" id="slow-responses">-</span>
        </div>
      </div>
    </div>

    <!-- Recent Queries -->
    <div class="card">
      <h2>üîÑ Recent Queries</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Provider</th>
              <th>Model</th>
              <th>Query</th>
              <th>Latency</th>
              <th>Cache</th>
            </tr>
          </thead>
          <tbody id="recent-queries">
            <tr>
              <td colspan="6" class="loading">Loading recent queries...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="last-update">
      Last updated: <span id="last-update">Never</span> ‚Ä¢ Auto-refresh every 5 seconds
    </div>
  </div>

  <script>
    let refreshInterval;
    const BASE_URL = window.location.origin;

    // Format timestamp
    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString();
    }

    // Format latency with color coding
    function formatLatency(ms) {
      if (ms === null || ms === undefined) return '-';

      const value = Math.round(ms);
      let className = '';

      if (value < 100) className = 'good';
      else if (value < 5000) className = '';
      else className = 'bad';

      return `<span class="${className}">${value}ms</span>`;
    }

    // Format cache status badge
    function formatCacheStatus(cacheHit) {
      if (cacheHit === true) {
        return '<span class="badge badge-green">HIT</span>';
      } else if (cacheHit === false) {
        return '<span class="badge badge-gray">MISS</span>';
      }
      return '<span class="badge badge-gray">-</span>';
    }

    // Update system status
    async function updateSystemStatus() {
      try {
        // Check router
        const healthRes = await fetch(`${BASE_URL}/health`);
        const health = await healthRes.json();

        if (health.status === 'ok') {
          document.getElementById('router-status').textContent = '‚úÖ Online';
          document.getElementById('router-status').className = 'metric-value good';
        } else {
          document.getElementById('router-status').textContent = '‚ö†Ô∏è Issues';
          document.getElementById('router-status').className = 'metric-value warning';
        }

        // Check Ollama (via router)
        try {
          const agentsRes = await fetch(`${BASE_URL}/agents`);
          const agents = await agentsRes.json();

          if (agents.agents && agents.agents.some(a => a.name === 'ollama')) {
            document.getElementById('ollama-status').textContent = '‚úÖ Available';
            document.getElementById('ollama-status').className = 'metric-value good';
          } else {
            document.getElementById('ollama-status').textContent = '‚ö†Ô∏è Not Found';
            document.getElementById('ollama-status').className = 'metric-value warning';
          }
        } catch (e) {
          document.getElementById('ollama-status').textContent = '‚ùå Error';
          document.getElementById('ollama-status').className = 'metric-value bad';
        }

        // Database status (assume OK if router is OK)
        document.getElementById('database-status').textContent = '‚úÖ Connected';
        document.getElementById('database-status').className = 'metric-value good';

        // Overall system status
        document.getElementById('system-status').className = 'status-indicator status-ok';

      } catch (error) {
        console.error('System status check failed:', error);
        document.getElementById('router-status').textContent = '‚ùå Offline';
        document.getElementById('router-status').className = 'metric-value bad';
        document.getElementById('system-status').className = 'status-indicator status-error';
      }
    }

    // Fetch verification data
    async function fetchVerificationData() {
      try {
        const response = await fetch(`${BASE_URL}/api/verification-stats`);

        if (!response.ok) {
          throw new Error('Verification API not available');
        }

        const data = await response.json();

        // Overall stats
        document.getElementById('total-queries').textContent = data.totalQueries || 0;
        document.getElementById('queries-with-timing').textContent = data.queriesWithTiming || 0;
        document.getElementById('cache-hits').textContent = data.cacheHits || 0;
        document.getElementById('cache-hit-rate').textContent = data.cacheHitRate ? `${data.cacheHitRate}%` : '-';

        // Latency stats
        const avgLatency = data.avgLatency ? Math.round(data.avgLatency) : '-';
        document.getElementById('avg-latency').textContent = avgLatency;
        document.getElementById('avg-latency-2').textContent = avgLatency !== '-' ? `${avgLatency}ms` : '-';

        document.getElementById('min-latency').textContent = data.minLatency ? `${Math.round(data.minLatency)}ms` : '-';
        document.getElementById('max-latency').textContent = data.maxLatency ? `${Math.round(data.maxLatency)}ms` : '-';
        document.getElementById('p50-latency').textContent = data.p50Latency ? `${Math.round(data.p50Latency)}ms` : '-';
        document.getElementById('p95-latency').textContent = data.p95Latency ? `${Math.round(data.p95Latency)}ms` : '-';
        document.getElementById('p99-latency').textContent = data.p99Latency ? `${Math.round(data.p99Latency)}ms` : '-';

        // Cache performance
        document.getElementById('cache-hit-latency').textContent = data.cacheHitLatency ? `${Math.round(data.cacheHitLatency)}ms` : '-';
        document.getElementById('cache-miss-latency').textContent = data.cacheMissLatency ? `${Math.round(data.cacheMissLatency)}ms` : '-';

        if (data.cacheHitLatency && data.cacheMissLatency) {
          const speedup = (data.cacheMissLatency / data.cacheHitLatency).toFixed(1);
          document.getElementById('speedup-factor').textContent = `${speedup}√ó`;
        }

        // Response categories
        document.getElementById('fast-responses').textContent = data.fastResponses || 0;
        document.getElementById('normal-responses').textContent = data.normalResponses || 0;
        document.getElementById('slow-responses').textContent = data.slowResponses || 0;

        // Recent queries
        if (data.recentQueries && data.recentQueries.length > 0) {
          const tbody = document.getElementById('recent-queries');
          tbody.innerHTML = data.recentQueries.map(q => `
            <tr>
              <td>${formatTimestamp(q.request_timestamp)}</td>
              <td>${q.provider}</td>
              <td>${q.model}</td>
              <td>${q.query_text ? q.query_text.substring(0, 50) + '...' : '-'}</td>
              <td>${formatLatency(q.latency_ms)}</td>
              <td>${formatCacheStatus(q.cache_hit)}</td>
            </tr>
          `).join('');
        }

        // Update last update time
        document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

      } catch (error) {
        console.error('Failed to fetch verification data:', error);

        // Show error in recent queries table
        const tbody = document.getElementById('recent-queries');
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="error-message">
              ‚ö†Ô∏è Verification API not available. Make sure router is running with database support.
            </td>
          </tr>
        `;
      }
    }

    // Mock data for when API is not available
    function useMockData() {
      // This will be called if the real API is not available
      // For now, just show loading state
    }

    // Initialize dashboard
    async function init() {
      await updateSystemStatus();
      await fetchVerificationData();

      // Refresh every 5 seconds
      refreshInterval = setInterval(async () => {
        await updateSystemStatus();
        await fetchVerificationData();
      }, 5000);
    }

    // Start dashboard
    init();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>
</body>
</html>
