<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Privacy Audit Lab - CalOS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Monaco', 'Courier New', monospace;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #0f0f23;
      color: #e0e0e0;
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #888;
      margin-bottom: 30px;
    }

    .section {
      background: #1a1a2e;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #2a2a3e;
    }

    .section h2 {
      color: #764ba2;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      padding: 12px 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #444;
      cursor: not-allowed;
      transform: none;
    }

    .output {
      background: #0a0a15;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.6;
      min-height: 100px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #2a2a3e;
    }

    .output.error {
      border-left: 4px solid #e74c3c;
      background: #1a0a0a;
    }

    .output.success {
      border-left: 4px solid #4caf50;
    }

    .output.warning {
      border-left: 4px solid #f39c12;
      background: #1a1508;
    }

    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status.online {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .status.offline {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
      font-size: 12px;
    }

    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 10px;
      background: #0a0a15;
      border: 1px solid #2a2a3e;
      border-radius: 5px;
      color: #e0e0e0;
      font-family: inherit;
      font-size: 13px;
    }

    .input-group input:focus,
    .input-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .finding {
      background: #0a0a15;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 5px;
      border-left: 3px solid #e74c3c;
    }

    .finding.warning {
      border-left-color: #f39c12;
    }

    .finding.safe {
      border-left-color: #4caf50;
    }

    .finding-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: #e74c3c;
    }

    .finding.warning .finding-title {
      color: #f39c12;
    }

    .finding.safe .finding-title {
      color: #4caf50;
    }

    .finding-desc {
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .finding-data {
      background: #000;
      padding: 8px;
      border-radius: 3px;
      font-size: 11px;
      margin-top: 5px;
      overflow-x: auto;
    }

    .score-card {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .score-item {
      background: #0a0a15;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .score-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .score-value.high {
      color: #e74c3c;
    }

    .score-value.medium {
      color: #f39c12;
    }

    .score-value.low {
      color: #4caf50;
    }

    .score-label {
      color: #888;
      font-size: 12px;
    }

    .pii-types {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .pii-badge {
      background: #e74c3c;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>MCP Privacy Audit Tool</h1>
  <p class="subtitle">Scan for PII, check encryption, and ensure data privacy compliance</p>

  <!-- Server Status -->
  <div class="section">
    <h2>Server Status</h2>
    <div id="status-container">
      <span class="status offline">Offline</span>
      <span id="status-details" style="margin-left: 10px; color: #888;">Checking...</span>
    </div>
    <button onclick="checkServerStatus()" style="margin-top: 10px;">Refresh Status</button>
  </div>

  <!-- Privacy Score -->
  <div class="section" id="score-section" style="display: none;">
    <h2>Privacy Score</h2>
    <div class="score-card" id="score-card">
      <!-- Scores will be populated here -->
    </div>
  </div>

  <!-- Scan Configuration -->
  <div class="section">
    <h2>Scan Configuration</h2>

    <div class="input-group">
      <label>Data to Scan (JSON or Text):</label>
      <textarea id="scan-data" rows="10" placeholder='{"email": "user@example.com", "ssn": "123-45-6789", ...}'>{
  "userId": "user-123",
  "email": "john.doe@example.com",
  "phone": "(555) 123-4567",
  "ssn": "123-45-6789",
  "creditCard": "4532-1234-5678-9010",
  "address": "123 Main St, Anytown, CA 12345",
  "password": "unencrypted-password-123",
  "encrypted_token": "AES256:j8fh3j4hg5..."
}</textarea>
    </div>

    <div class="button-grid">
      <button onclick="scanForPII()">Scan for PII</button>
      <button onclick="checkEncryption()">Check Encryption</button>
      <button onclick="fullAudit()">Full Privacy Audit</button>
      <button onclick="loadSampleData()">Load Sample Data</button>
    </div>
  </div>

  <!-- Quick Scans -->
  <div class="section">
    <h2>Quick Scans</h2>
    <div class="button-grid">
      <button onclick="scanFile('.env')">Scan .env File</button>
      <button onclick="scanFile('config.json')">Scan config.json</button>
      <button onclick="scanDirectory('./data')">Scan /data</button>
      <button onclick="scanDirectory('./lib')">Scan /lib</button>
      <button onclick="scanLogs()">Scan Logs</button>
      <button onclick="scanDatabase()">Scan Database</button>
    </div>
  </div>

  <!-- Findings -->
  <div class="section">
    <h2>Privacy Findings</h2>
    <div id="findings">
      <pre class="output">Run a privacy audit to see findings...</pre>
    </div>
  </div>

  <!-- Output -->
  <div class="section">
    <h2>Detailed Output</h2>
    <pre class="output" id="output">Configure scan and click a button...</pre>
  </div>

  <script>
    const MCP_URL = 'http://localhost:3100';
    const output = document.getElementById('output');

    // PII patterns
    const PII_PATTERNS = {
      email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,
      ssn: /\b\d{3}-\d{2}-\d{4}\b/g,
      creditCard: /\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b/g,
      phone: /\b(\+\d{1,2}\s?)?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}\b/g,
      ip: /\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/g,
      apiKey: /\b[A-Za-z0-9]{32,}\b/g
    };

    // Log to output
    function log(message, type = 'default') {
      const formatted = typeof message === 'string'
        ? message
        : JSON.stringify(message, null, 2);

      output.textContent = formatted;
      output.className = 'output';

      if (type === 'error') {
        output.classList.add('error');
      } else if (type === 'success') {
        output.classList.add('success');
      } else if (type === 'warning') {
        output.classList.add('warning');
      }
    }

    // Check server status
    async function checkServerStatus() {
      const statusContainer = document.getElementById('status-container');

      try {
        const response = await fetch(`${MCP_URL}/mcp/health`);
        const data = await response.json();

        statusContainer.innerHTML = `
          <span class="status online">Online</span>
          <span id="status-details" style="margin-left: 10px; color: #4caf50;">
            ${data.tools} tools available | Uptime: ${Math.floor(data.uptime)}s
          </span>
        `;
      } catch (error) {
        statusContainer.innerHTML = `
          <span class="status offline">Offline</span>
          <span id="status-details" style="margin-left: 10px; color: #e74c3c;">
            Cannot connect. Run: ./bin/mcp-server
          </span>
        `;
      }
    }

    // Scan for PII
    function scanForPII() {
      try {
        const data = document.getElementById('scan-data').value;
        const findings = [];

        // Scan for each PII type
        for (const [type, pattern] of Object.entries(PII_PATTERNS)) {
          const matches = data.match(pattern);
          if (matches) {
            findings.push({
              type: 'critical',
              category: type.toUpperCase(),
              count: matches.length,
              samples: matches.slice(0, 3),
              recommendation: `Found ${matches.length} ${type} value(s). Ensure they are encrypted or removed.`
            });
          }
        }

        displayFindings(findings);
        updateScore(findings);

        if (findings.length > 0) {
          log(`Found ${findings.length} PII types in data:\n\n${findings.map(f => `- ${f.category}: ${f.count} instance(s)`).join('\n')}`, 'warning');
        } else {
          log('No PII detected in data. Privacy scan passed!', 'success');
        }
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
      }
    }

    // Check encryption
    function checkEncryption() {
      try {
        const data = document.getElementById('scan-data').value;
        const findings = [];

        // Check for unencrypted sensitive fields
        const sensitiveFields = ['password', 'secret', 'token', 'key', 'apiKey', 'accessToken'];

        try {
          const parsed = JSON.parse(data);

          for (const [key, value] of Object.entries(parsed)) {
            const isEncrypted = String(value).match(/^(AES256|RSA|encrypted):/i);
            const isSensitive = sensitiveFields.some(field =>
              key.toLowerCase().includes(field.toLowerCase())
            );

            if (isSensitive && !isEncrypted) {
              findings.push({
                type: 'critical',
                category: 'UNENCRYPTED',
                field: key,
                recommendation: `Field "${key}" appears sensitive but is not encrypted. Use AES-256 encryption.`
              });
            }
          }
        } catch (e) {
          // Not JSON, scan raw text
          sensitiveFields.forEach(field => {
            const regex = new RegExp(`${field}["\\'\\s]*[:=]["\\'\\s]*([^"\\'\\s,}]+)`, 'gi');
            const matches = data.match(regex);
            if (matches) {
              findings.push({
                type: 'warning',
                category: 'UNENCRYPTED',
                field: field,
                count: matches.length,
                recommendation: `Found unencrypted "${field}" field(s). Consider encryption.`
              });
            }
          });
        }

        displayFindings(findings);

        if (findings.length > 0) {
          log(`Found ${findings.length} unencrypted sensitive field(s):\n\n${findings.map(f => `- ${f.field || f.category}`).join('\n')}`, 'error');
        } else {
          log('All sensitive fields appear to be encrypted!', 'success');
        }
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
      }
    }

    // Full privacy audit
    function fullAudit() {
      scanForPII();
      setTimeout(() => checkEncryption(), 500);
    }

    // Display findings
    function displayFindings(findings) {
      const findingsDiv = document.getElementById('findings');

      if (findings.length === 0) {
        findingsDiv.innerHTML = '<pre class="output success">No privacy issues found!</pre>';
        return;
      }

      let html = '';
      findings.forEach(finding => {
        const severity = finding.type === 'critical' ? '' : ' warning';
        html += `
          <div class="finding${severity}">
            <div class="finding-title">${finding.category}</div>
            <div class="finding-desc">${finding.recommendation}</div>
            ${finding.samples ? `<div class="finding-data">${finding.samples.join(', ')}</div>` : ''}
            ${finding.count ? `<div class="finding-desc" style="margin-top: 5px;">Count: ${finding.count}</div>` : ''}
          </div>
        `;
      });

      findingsDiv.innerHTML = html;
    }

    // Update privacy score
    function updateScore(findings) {
      const scoreSection = document.getElementById('score-section');
      const scoreCard = document.getElementById('score-card');

      scoreSection.style.display = 'block';

      const criticalCount = findings.filter(f => f.type === 'critical').length;
      const warningCount = findings.filter(f => f.type === 'warning').length;
      const totalIssues = findings.length;

      // Calculate score (0-100, lower is better)
      const score = Math.max(0, 100 - (criticalCount * 20 + warningCount * 10));
      const scoreClass = score >= 80 ? 'low' : score >= 50 ? 'medium' : 'high';

      scoreCard.innerHTML = `
        <div class="score-item">
          <div class="score-value ${scoreClass}">${score}</div>
          <div class="score-label">Privacy Score</div>
        </div>
        <div class="score-item">
          <div class="score-value high">${criticalCount}</div>
          <div class="score-label">Critical Issues</div>
        </div>
        <div class="score-item">
          <div class="score-value medium">${warningCount}</div>
          <div class="score-label">Warnings</div>
        </div>
        <div class="score-item">
          <div class="score-value ${totalIssues === 0 ? 'low' : 'high'}">${totalIssues}</div>
          <div class="score-label">Total Issues</div>
        </div>
      `;
    }

    // Load sample data
    function loadSampleData() {
      const samples = [
        {
          name: 'Clean Data',
          data: JSON.stringify({
            userId: 'user-123',
            username: 'johndoe',
            role: 'admin',
            encrypted_email: 'AES256:encrypted_data_here',
            encrypted_phone: 'AES256:encrypted_data_here'
          }, null, 2)
        },
        {
          name: 'Exposed PII',
          data: JSON.stringify({
            userId: 'user-123',
            email: 'john.doe@example.com',
            phone: '(555) 123-4567',
            ssn: '123-45-6789',
            creditCard: '4532-1234-5678-9010'
          }, null, 2)
        },
        {
          name: 'Unencrypted Secrets',
          data: JSON.stringify({
            apiKey: 'sk_live_1234567890abcdef',
            password: 'MyPassword123!',
            secret: 'super-secret-key'
          }, null, 2)
        }
      ];

      const choice = prompt('Choose sample:\n1. Clean Data\n2. Exposed PII\n3. Unencrypted Secrets', '2');
      const index = parseInt(choice) - 1;

      if (index >= 0 && index < samples.length) {
        document.getElementById('scan-data').value = samples[index].data;
        log(`Loaded sample: ${samples[index].name}`, 'success');
      }
    }

    // Scan file (demo)
    async function scanFile(filename) {
      log(`Scanning ${filename}...\n\nThis would use the filesystem_read MCP tool to read the file and scan its contents.`, 'success');
    }

    // Scan directory (demo)
    async function scanDirectory(dir) {
      log(`Scanning directory ${dir}...\n\nThis would use filesystem_list and filesystem_read MCP tools to scan all files recursively.`, 'success');
    }

    // Scan logs (demo)
    async function scanLogs() {
      log('Scanning application logs...\n\nThis would search log files for accidentally logged PII (emails, IPs, tokens, etc.)', 'success');
    }

    // Scan database (demo)
    async function scanDatabase() {
      log('Scanning database for unencrypted PII...\n\nThis would connect to the database and check for:\n- Unencrypted email/phone columns\n- Plain text passwords\n- Exposed API keys', 'success');
    }

    // Check status on load
    window.addEventListener('load', () => {
      checkServerStatus();
    });
  </script>
</body>
</html>
