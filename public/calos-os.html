<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0a">
  <title>CalOS - Operating System</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNhbE9TIiwKICAic2hvcnRfbmFtZSI6ICJDYWxPUyIsCiAgInN0YXJ0X3VybCI6ICIvY2Fsb3Mtb3MuaHRtbCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzBhMGEwYSIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDgwZmYiLAogICJpY29ucyI6IFt7CiAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmclMjB4bWxucyUzRCUyN2h0dHAlM0ElMkYlMkZ3d3cudzMub3JnJTJGMjAwMCUyRnN2ZyclMjd3aWR0aCUzRCUyNzUxMiUyN2hlaWdodCUzRCUyNzUxMiUyN3ZpZXdCb3glM0QlMjcwJTIwMCUyMDUxMiUyMDUxMiUyNyUzRSUzQ3JlY3QlMjBmaWxsJTNEJyUyMzAwODBmZiclMjB3aWR0aCUzRCc1MTInJTIwaGVpZ2h0JTNEJzUxMicvcyUzRSUzQ3RleHQlMjBmaWxsJTNEJyUyM2ZmZiclMjBmb250LXNpemUlM0QnMzAwJyUyMHglM0QnNTAlMjUnJTIweSUzRCc1MCUyNSUyNyUyMGRvbWluYW50LWJhc2VsaW5lJTNEJ21pZGRsZSclMjB0ZXh0LWFuY2hvciUzRCdtaWRkbGUnJTNFQyUzQyUyRnRleHQlM0UlM0MlMkZzdmclM0UiLAogICAgInNpemVzIjogIjUxMng1MTIiLAogICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICB9XQp9">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'width='512'height='512'viewBox='0 0 512 512'%3E%3Crect fill='%230080ff' width='512' height='512'/%3E%3Ctext fill='%23fff' font-size='300' x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">

  <!-- Capacitor Runtime (for native iOS/Android features) -->
  <script type="module">
    // Create Capacitor shim if not running in native
    if (typeof Capacitor === 'undefined') {
      window.Capacitor = {
        isNativePlatform: () => false,
        Plugins: {}
      };
    }
  </script>

  <style>
    /* Reset & Variables */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #252525;
      --border: #333;
      --text-primary: #e0e0e0;
      --text-secondary: #888;
      --accent-blue: #0080ff;
      --accent-green: #00ff88;
      --accent-red: #ff4444;
      --accent-yellow: #ffaa00;
      --accent-purple: #aa00ff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      touch-action: manipulation;
    }

    /* Boot Screen */
    #bootScreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      transition: opacity 0.5s;
    }

    #bootScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .boot-logo {
      font-size: 80px;
      font-weight: bold;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 30px;
    }

    .boot-text {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 20px;
    }

    .boot-progress {
      width: 300px;
      height: 4px;
      background: var(--bg-secondary);
      border-radius: 2px;
      overflow: hidden;
    }

    .boot-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
      width: 0%;
      animation: bootProgress 2s ease-in-out forwards;
    }

    @keyframes bootProgress {
      to { width: 100%; }
    }

    /* Desktop */
    .desktop {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Status Bar */
    .status-bar {
      height: 30px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      font-size: 11px;
    }

    .status-left, .status-right {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-green);
    }

    .status-dot.offline { background: var(--accent-red); }

    /* App Grid */
    .app-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 20px;
      padding: 40px;
      overflow-y: auto;
    }

    .app-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: transform 0.2s;
      user-select: none;
    }

    .app-icon:hover {
      transform: translateY(-5px);
    }

    .app-icon:active {
      transform: scale(0.95);
    }

    .app-icon-image {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border: 2px solid var(--border);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .app-icon-label {
      font-size: 12px;
      text-align: center;
    }

    /* Window System */
    .window {
      position: absolute;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      min-width: 400px;
      min-height: 300px;
      display: none;
      flex-direction: column;
    }

    .window.active {
      display: flex;
      z-index: 1000;
    }

    .window.maximized {
      top: 30px !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 50px !important;
      width: 100% !important;
      height: calc(100vh - 80px) !important;
      border-radius: 0;
    }

    .window-titlebar {
      height: 40px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
      border-radius: 12px 12px 0 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      cursor: move;
    }

    .window-title {
      font-size: 13px;
      font-weight: 600;
    }

    .window-controls {
      display: flex;
      gap: 8px;
    }

    .window-control {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
    }

    .window-control.close { background: #ff5f57; }
    .window-control.minimize { background: #ffbd2e; }
    .window-control.maximize { background: #28ca42; }

    .window-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    /* Window Resize Handles */
    .window-resize-handle {
      position: absolute;
      z-index: 10;
    }

    /* Edge handles */
    .window-resize-handle.top {
      top: 0;
      left: 10px;
      right: 10px;
      height: 6px;
      cursor: ns-resize;
    }

    .window-resize-handle.right {
      top: 10px;
      right: 0;
      bottom: 10px;
      width: 6px;
      cursor: ew-resize;
    }

    .window-resize-handle.bottom {
      bottom: 0;
      left: 10px;
      right: 10px;
      height: 6px;
      cursor: ns-resize;
    }

    .window-resize-handle.left {
      top: 10px;
      left: 0;
      bottom: 10px;
      width: 6px;
      cursor: ew-resize;
    }

    /* Corner handles */
    .window-resize-handle.top-left {
      top: 0;
      left: 0;
      width: 10px;
      height: 10px;
      cursor: nwse-resize;
    }

    .window-resize-handle.top-right {
      top: 0;
      right: 0;
      width: 10px;
      height: 10px;
      cursor: nesw-resize;
    }

    .window-resize-handle.bottom-left {
      bottom: 0;
      left: 0;
      width: 10px;
      height: 10px;
      cursor: nesw-resize;
    }

    .window-resize-handle.bottom-right {
      bottom: 0;
      right: 0;
      width: 10px;
      height: 10px;
      cursor: nwse-resize;
    }

    /* Pulse effect for resize/drag */
    @keyframes pulse {
      0% {
        box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 0 0 0 rgba(0, 128, 255, 0.7);
      }
      50% {
        box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 0 0 10px rgba(0, 128, 255, 0);
      }
      100% {
        box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 0 0 0 rgba(0, 128, 255, 0);
      }
    }

    .window.resizing,
    .window.dragging {
      animation: pulse 1s infinite;
    }

    /* Dock */
    .dock {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 30, 30, 0.9);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 10px;
      display: flex;
      gap: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .dock-icon {
      width: 50px;
      height: 50px;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .dock-icon:hover {
      transform: translateY(-10px);
      border-color: var(--accent-blue);
    }

    .dock-icon.active::after {
      content: '';
      position: absolute;
      bottom: -5px;
      width: 4px;
      height: 4px;
      background: var(--accent-blue);
      border-radius: 50%;
    }

    /* UI Components */
    .btn {
      padding: 10px 20px;
      background: var(--accent-blue);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #0066cc;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-success { background: var(--accent-green); color: var(--bg-primary); }
    .btn-danger { background: var(--accent-red); }

    .input {
      width: 100%;
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .list-item {
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .app-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 15px;
        padding: 20px;
      }

      .window {
        min-width: 100vw;
        min-height: 100vh;
        border-radius: 0;
      }

      .dock {
        bottom: 0;
        left: 0;
        transform: none;
        border-radius: 0;
        width: 100%;
        justify-content: space-around;
      }
    }
  </style>
</head>
<body>
  <!-- Boot Screen -->
  <div id="bootScreen">
    <div class="boot-logo">CalOS</div>
    <div class="boot-text">Initializing operating system...</div>
    <div class="boot-progress">
      <div class="boot-progress-fill"></div>
    </div>
  </div>

  <!-- Desktop -->
  <div class="desktop" style="display: none;">
    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-left">
        <div class="status-item">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Offline Mode</span>
        </div>
        <div class="status-item" id="platformInfo" style="display: none;">
          <span id="platformBadge"></span>
        </div>
        <div class="status-item" id="storageInfo">
          Storage: <span id="storageUsed">0</span>KB used
        </div>
      </div>
      <div class="status-right">
        <div class="status-item" id="languageSelector">
          🌍 <select onchange="CalOS.setLanguage(this.value)" style="background: transparent; border: none; color: var(--text-primary); font-size: 11px;">
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="business">Business</option>
          </select>
        </div>
        <div class="status-item" id="clock">--:--:--</div>
      </div>
    </div>

    <!-- App Grid -->
    <div class="app-grid">
      <div class="app-icon" onclick="CalOS.openWindow('filesWindow')">
        <div class="app-icon-image">📁</div>
        <div class="app-icon-label" data-i18n="files">Files</div>
      </div>

      <div class="app-icon" onclick="CalOS.openWindow('chatWindow')">
        <div class="app-icon-image">💬</div>
        <div class="app-icon-label" data-i18n="chat">Chat</div>
      </div>

      <div class="app-icon" onclick="CalOS.openWindow('keysWindow')">
        <div class="app-icon-image">🔑</div>
        <div class="app-icon-label" data-i18n="apikeys">API Keys</div>
      </div>

      <div class="app-icon" onclick="CalOS.openWindow('modelsWindow')">
        <div class="app-icon-image">🤖</div>
        <div class="app-icon-label" data-i18n="models">Models</div>
      </div>

      <div class="app-icon" onclick="CalOS.openWindow('storeWindow')">
        <div class="app-icon-image">🏪</div>
        <div class="app-icon-label" data-i18n="appstore">App Store</div>
      </div>

      <div class="app-icon" onclick="CalOS.openWindow('settingsWindow')">
        <div class="app-icon-image">⚙️</div>
        <div class="app-icon-label" data-i18n="settings">Settings</div>
      </div>

      <div class="app-icon" onclick="CalOS.openWindow('calculatorWindow')">
        <div class="app-icon-image">🧮</div>
        <div class="app-icon-label">Calculator</div>
      </div>
    </div>

    <!-- Dock -->
    <div class="dock">
      <div class="dock-icon" onclick="CalOS.openWindow('authWindow')" title="Login">🔐</div>
      <div class="dock-icon" onclick="CalOS.openWindow('filesWindow')" title="Files">📁</div>
      <div class="dock-icon" onclick="CalOS.openWindow('chatWindow')" title="Chat">💬</div>
      <div class="dock-icon" onclick="CalOS.openWindow('modelsWindow')" title="Models">🤖</div>
      <div class="dock-icon" onclick="CalOS.openWindow('storeWindow')" title="App Store">🏪</div>
    </div>
  </div>

  <!-- Windows -->
  <!-- Login/Register Window -->
  <div id="authWindow" class="window" style="top: 100px; left: 100px; width: 450px; height: 550px;">
    <div class="window-titlebar" onmousedown="CalOS.startDrag(event, 'authWindow')">
      <div class="window-title" data-i18n="auth">Login / Register</div>
      <div class="window-controls">
        <div class="window-control close" onclick="CalOS.closeWindow('authWindow')"></div>
        <div class="window-control minimize"></div>
        <div class="window-control maximize" onclick="CalOS.toggleMaximize('authWindow')"></div>
      </div>
    </div>
    <!-- Resize Handles -->
    <div class="window-resize-handle top" onmousedown="CalOS.startResize(event, 'authWindow', 'top')"></div>
    <div class="window-resize-handle right" onmousedown="CalOS.startResize(event, 'authWindow', 'right')"></div>
    <div class="window-resize-handle bottom" onmousedown="CalOS.startResize(event, 'authWindow', 'bottom')"></div>
    <div class="window-resize-handle left" onmousedown="CalOS.startResize(event, 'authWindow', 'left')"></div>
    <div class="window-resize-handle top-left" onmousedown="CalOS.startResize(event, 'authWindow', 'top-left')"></div>
    <div class="window-resize-handle top-right" onmousedown="CalOS.startResize(event, 'authWindow', 'top-right')"></div>
    <div class="window-resize-handle bottom-left" onmousedown="CalOS.startResize(event, 'authWindow', 'bottom-left')"></div>
    <div class="window-resize-handle bottom-right" onmousedown="CalOS.startResize(event, 'authWindow', 'bottom-right')"></div>
    <div class="window-content">
      <!-- Not logged in view -->
      <div id="authFormView" style="display: block;">
        <div class="card">
          <h3 style="margin-bottom: 20px;">Welcome to CalOS</h3>

          <!-- Tab Switcher -->
          <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border);">
            <button id="loginTab" class="btn" onclick="CalOS.switchAuthTab('login')" style="flex: 1; border-radius: 8px 8px 0 0; border-bottom: 3px solid var(--accent-blue);">Login</button>
            <button id="registerTab" class="btn" onclick="CalOS.switchAuthTab('register')" style="flex: 1; border-radius: 8px 8px 0 0; border-bottom: none;">Register</button>
          </div>

          <!-- Login Form -->
          <div id="loginForm" style="display: block;">
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-secondary);">Email</label>
              <input type="email" id="loginEmail" class="input" placeholder="your@email.com" value="">
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-secondary);">Password</label>
              <input type="password" id="loginPassword" class="input" placeholder="••••••••" onkeydown="if(event.key==='Enter'){event.preventDefault();CalOS.login();}">
            </div>
            <button class="btn" onclick="CalOS.login()" style="width: 100%; background: var(--accent-blue); font-weight: 600;">Login</button>
            <div id="loginError" style="margin-top: 15px; padding: 10px; background: var(--accent-red); border-radius: 6px; display: none; font-size: 13px;"></div>
          </div>

          <!-- Register Form -->
          <div id="registerForm" style="display: none;">
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-secondary);">Email</label>
              <input type="email" id="registerEmail" class="input" placeholder="your@email.com">
            </div>
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-secondary);">Username</label>
              <input type="text" id="registerUsername" class="input" placeholder="username">
            </div>
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-secondary);">Password</label>
              <input type="password" id="registerPassword" class="input" placeholder="••••••••">
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-secondary);">Confirm Password</label>
              <input type="password" id="registerPasswordConfirm" class="input" placeholder="••••••••" onkeydown="if(event.key==='Enter'){event.preventDefault();CalOS.register();}">
            </div>
            <button class="btn" onclick="CalOS.register()" style="width: 100%; background: var(--accent-green); font-weight: 600;">Create Account</button>
            <div id="registerError" style="margin-top: 15px; padding: 10px; background: var(--accent-red); border-radius: 6px; display: none; font-size: 13px;"></div>
          </div>
        </div>
      </div>

      <!-- Logged in view -->
      <div id="authProfileView" style="display: none;">
        <div class="card">
          <h3 style="margin-bottom: 20px;">Profile</h3>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-secondary);">Username</label>
            <div id="profileUsername" style="padding: 10px; background: var(--bg-tertiary); border-radius: 6px; font-weight: 600;">—</div>
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-secondary);">Email</label>
            <div id="profileEmail" style="padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">—</div>
          </div>
          <button class="btn" onclick="CalOS.logout()" style="width: 100%; background: var(--accent-red); font-weight: 600;">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Files Window -->
  <div id="filesWindow" class="window" style="top: 100px; left: 100px; width: 600px; height: 500px;">
    <div class="window-titlebar" onmousedown="CalOS.startDrag(event, 'filesWindow')">
      <div class="window-title" data-i18n="files">Files</div>
      <div class="window-controls">
        <div class="window-control close" onclick="CalOS.closeWindow('filesWindow')"></div>
        <div class="window-control minimize"></div>
        <div class="window-control maximize" onclick="CalOS.toggleMaximize('filesWindow')"></div>
      </div>
    </div>
    <!-- Resize Handles -->
    <div class="window-resize-handle top" onmousedown="CalOS.startResize(event, 'filesWindow', 'top')"></div>
    <div class="window-resize-handle right" onmousedown="CalOS.startResize(event, 'filesWindow', 'right')"></div>
    <div class="window-resize-handle bottom" onmousedown="CalOS.startResize(event, 'filesWindow', 'bottom')"></div>
    <div class="window-resize-handle left" onmousedown="CalOS.startResize(event, 'filesWindow', 'left')"></div>
    <div class="window-resize-handle top-left" onmousedown="CalOS.startResize(event, 'filesWindow', 'top-left')"></div>
    <div class="window-resize-handle top-right" onmousedown="CalOS.startResize(event, 'filesWindow', 'top-right')"></div>
    <div class="window-resize-handle bottom-left" onmousedown="CalOS.startResize(event, 'filesWindow', 'bottom-left')"></div>
    <div class="window-resize-handle bottom-right" onmousedown="CalOS.startResize(event, 'filesWindow', 'bottom-right')"></div>
    <div class="window-content">
      <div class="card">
        <h3 style="margin-bottom: 15px;">File System</h3>
        <div>
          <input type="file" id="fileInput" style="display: none;" onchange="CalOS.uploadFile(this.files[0])">
          <button class="btn" onclick="document.getElementById('fileInput').click()">+ Upload File</button>
        </div>
        <div id="fileList" style="margin-top: 20px;"></div>
      </div>
    </div>
  </div>

  <!-- Chat Window -->
  <div id="chatWindow" class="window" style="top: 120px; left: 150px; width: 700px; height: 600px;">
    <div class="window-titlebar" onmousedown="CalOS.startDrag(event, 'chatWindow')">
      <div class="window-title" data-i18n="chat">Chat</div>
      <div class="window-controls">
        <div class="window-control close" onclick="CalOS.closeWindow('chatWindow')"></div>
        <div class="window-control minimize"></div>
        <div class="window-control maximize" onclick="CalOS.toggleMaximize('chatWindow')"></div>
      </div>
    </div>
    <!-- Resize Handles -->
    <div class="window-resize-handle top" onmousedown="CalOS.startResize(event, 'chatWindow', 'top')"></div>
    <div class="window-resize-handle right" onmousedown="CalOS.startResize(event, 'chatWindow', 'right')"></div>
    <div class="window-resize-handle bottom" onmousedown="CalOS.startResize(event, 'chatWindow', 'bottom')"></div>
    <div class="window-resize-handle left" onmousedown="CalOS.startResize(event, 'chatWindow', 'left')"></div>
    <div class="window-resize-handle top-left" onmousedown="CalOS.startResize(event, 'chatWindow', 'top-left')"></div>
    <div class="window-resize-handle top-right" onmousedown="CalOS.startResize(event, 'chatWindow', 'top-right')"></div>
    <div class="window-resize-handle bottom-left" onmousedown="CalOS.startResize(event, 'chatWindow', 'bottom-left')"></div>
    <div class="window-resize-handle bottom-right" onmousedown="CalOS.startResize(event, 'chatWindow', 'bottom-right')"></div>
    <div class="window-content" style="display: flex; flex-direction: column; padding: 0;">
      <div style="padding: 15px; border-bottom: 1px solid var(--border); background: var(--bg-tertiary);">
        <select id="chatModel" class="input" style="margin-bottom: 10px;">
          <option value="auto">Auto (ModelClarityEngine)</option>
          <option value="ollama">Ollama (Local)</option>
          <option value="openai">OpenAI</option>
          <option value="anthropic">Anthropic</option>
        </select>
      </div>
      <div id="chatMessages" style="flex: 1; padding: 20px; overflow-y: auto;"></div>
      <div style="padding: 15px; border-top: 1px solid var(--border);">
        <textarea id="chatInput" class="input" placeholder="Type your message..." style="resize: none; height: 60px; margin-bottom: 10px;" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();CalOS.sendMessage();}"></textarea>
        <button class="btn" onclick="CalOS.sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- API Keys Window -->
  <div id="keysWindow" class="window" style="top: 140px; left: 200px; width: 600px; height: 500px;">
    <div class="window-titlebar" onmousedown="CalOS.startDrag(event, 'keysWindow')">
      <div class="window-title" data-i18n="apikeys">API Keys (BYOK)</div>
      <div class="window-controls">
        <div class="window-control close" onclick="CalOS.closeWindow('keysWindow')"></div>
        <div class="window-control minimize"></div>
        <div class="window-control maximize" onclick="CalOS.toggleMaximize('keysWindow')"></div>
      </div>
    </div>
    <!-- Resize Handles -->
    <div class="window-resize-handle top" onmousedown="CalOS.startResize(event, 'keysWindow', 'top')"></div>
    <div class="window-resize-handle right" onmousedown="CalOS.startResize(event, 'keysWindow', 'right')"></div>
    <div class="window-resize-handle bottom" onmousedown="CalOS.startResize(event, 'keysWindow', 'bottom')"></div>
    <div class="window-resize-handle left" onmousedown="CalOS.startResize(event, 'keysWindow', 'left')"></div>
    <div class="window-resize-handle top-left" onmousedown="CalOS.startResize(event, 'keysWindow', 'top-left')"></div>
    <div class="window-resize-handle top-right" onmousedown="CalOS.startResize(event, 'keysWindow', 'top-right')"></div>
    <div class="window-resize-handle bottom-left" onmousedown="CalOS.startResize(event, 'keysWindow', 'bottom-left')"></div>
    <div class="window-resize-handle bottom-right" onmousedown="CalOS.startResize(event, 'keysWindow', 'bottom-right')"></div>
    <div class="window-content">
      <div class="card">
        <h3 style="margin-bottom: 10px;">Encrypted API Keys</h3>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">
          Your keys are encrypted with AES-256 and stored locally
        </p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
          <select id="keyProvider" class="input">
            <option value="">Select Provider</option>
            <option value="openai">OpenAI</option>
            <option value="anthropic">Anthropic</option>
            <option value="deepseek">DeepSeek</option>
          </select>
          <input type="password" id="keyValue" class="input" placeholder="API Key">
        </div>
        <button class="btn" onclick="CalOS.addApiKey()">Add Key</button>
        <div id="keysList" style="margin-top: 20px;"></div>
      </div>
    </div>
  </div>

  <!-- Models Window -->
  <div id="modelsWindow" class="window" style="top: 160px; left: 250px; width: 700px; height: 600px;">
    <div class="window-titlebar" onmousedown="CalOS.startDrag(event, 'modelsWindow')">
      <div class="window-title">Ollama Models</div>
      <div class="window-controls">
        <div class="window-control close" onclick="CalOS.closeWindow('modelsWindow')"></div>
        <div class="window-control minimize"></div>
        <div class="window-control maximize" onclick="CalOS.toggleMaximize('modelsWindow')"></div>
      </div>
    </div>
    <!-- Resize Handles -->
    <div class="window-resize-handle top" onmousedown="CalOS.startResize(event, 'modelsWindow', 'top')"></div>
    <div class="window-resize-handle right" onmousedown="CalOS.startResize(event, 'modelsWindow', 'right')"></div>
    <div class="window-resize-handle bottom" onmousedown="CalOS.startResize(event, 'modelsWindow', 'bottom')"></div>
    <div class="window-resize-handle left" onmousedown="CalOS.startResize(event, 'modelsWindow', 'left')"></div>
    <div class="window-resize-handle top-left" onmousedown="CalOS.startResize(event, 'modelsWindow', 'top-left')"></div>
    <div class="window-resize-handle top-right" onmousedown="CalOS.startResize(event, 'modelsWindow', 'top-right')"></div>
    <div class="window-resize-handle bottom-left" onmousedown="CalOS.startResize(event, 'modelsWindow', 'bottom-left')"></div>
    <div class="window-resize-handle bottom-right" onmousedown="CalOS.startResize(event, 'modelsWindow', 'bottom-right')"></div>
    <div class="window-content">
      <div class="card">
        <h3 style="margin-bottom: 15px;">Available Models (<span id="modelCount">0</span>)</h3>
        <button class="btn btn-secondary" onclick="CalOS.refreshModels()">🔄 Refresh</button>
        <div id="modelsList" style="margin-top: 20px;"></div>
      </div>
    </div>
  </div>

  <!-- App Store Window -->
  <div id="storeWindow" class="window" style="top: 180px; left: 300px; width: 700px; height: 600px;">
    <div class="window-titlebar" onmousedown="CalOS.startDrag(event, 'storeWindow')">
      <div class="window-title" data-i18n="appstore">App Store</div>
      <div class="window-controls">
        <div class="window-control close" onclick="CalOS.closeWindow('storeWindow')"></div>
        <div class="window-control minimize"></div>
        <div class="window-control maximize" onclick="CalOS.toggleMaximize('storeWindow')"></div>
      </div>
    </div>
    <!-- Resize Handles -->
    <div class="window-resize-handle top" onmousedown="CalOS.startResize(event, 'storeWindow', 'top')"></div>
    <div class="window-resize-handle right" onmousedown="CalOS.startResize(event, 'storeWindow', 'right')"></div>
    <div class="window-resize-handle bottom" onmousedown="CalOS.startResize(event, 'storeWindow', 'bottom')"></div>
    <div class="window-resize-handle left" onmousedown="CalOS.startResize(event, 'storeWindow', 'left')"></div>
    <div class="window-resize-handle top-left" onmousedown="CalOS.startResize(event, 'storeWindow', 'top-left')"></div>
    <div class="window-resize-handle top-right" onmousedown="CalOS.startResize(event, 'storeWindow', 'top-right')"></div>
    <div class="window-resize-handle bottom-left" onmousedown="CalOS.startResize(event, 'storeWindow', 'bottom-left')"></div>
    <div class="window-resize-handle bottom-right" onmousedown="CalOS.startResize(event, 'storeWindow', 'bottom-right')"></div>
    <div class="window-content">
      <div class="card">
        <h3 style="margin-bottom: 15px;">Available Apps</h3>
        <div id="appStoreList">
          <div class="list-item">
            <div>
              <div style="font-weight: 600;">📊 Analytics Dashboard</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Visualize your data</div>
            </div>
            <button class="btn btn-success" onclick="CalOS.installApp('analytics')">Install (2MB)</button>
          </div>
          <div class="list-item">
            <div>
              <div style="font-weight: 600;">🔧 Workflow Builder</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Automate tasks</div>
            </div>
            <button class="btn btn-success" onclick="CalOS.installApp('workflow')">Install (3MB)</button>
          </div>
          <div class="list-item">
            <div>
              <div style="font-weight: 600;">👥 CRM System</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Manage contacts</div>
            </div>
            <button class="btn btn-success" onclick="CalOS.installApp('crm')">Install (5MB)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Window -->
  <div id="settingsWindow" class="window" style="top: 200px; left: 350px; width: 600px; height: 500px;">
    <div class="window-titlebar" onmousedown="CalOS.startDrag(event, 'settingsWindow')">
      <div class="window-title" data-i18n="settings">Settings</div>
      <div class="window-controls">
        <div class="window-control close" onclick="CalOS.closeWindow('settingsWindow')"></div>
        <div class="window-control minimize"></div>
        <div class="window-control maximize" onclick="CalOS.toggleMaximize('settingsWindow')"></div>
      </div>
    </div>
    <!-- Resize Handles -->
    <div class="window-resize-handle top" onmousedown="CalOS.startResize(event, 'settingsWindow', 'top')"></div>
    <div class="window-resize-handle right" onmousedown="CalOS.startResize(event, 'settingsWindow', 'right')"></div>
    <div class="window-resize-handle bottom" onmousedown="CalOS.startResize(event, 'settingsWindow', 'bottom')"></div>
    <div class="window-resize-handle left" onmousedown="CalOS.startResize(event, 'settingsWindow', 'left')"></div>
    <div class="window-resize-handle top-left" onmousedown="CalOS.startResize(event, 'settingsWindow', 'top-left')"></div>
    <div class="window-resize-handle top-right" onmousedown="CalOS.startResize(event, 'settingsWindow', 'top-right')"></div>
    <div class="window-resize-handle bottom-left" onmousedown="CalOS.startResize(event, 'settingsWindow', 'bottom-left')"></div>
    <div class="window-resize-handle bottom-right" onmousedown="CalOS.startResize(event, 'settingsWindow', 'bottom-right')"></div>
    <div class="window-content">
      <div class="card">
        <h3 style="margin-bottom: 15px;">System Settings</h3>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px;">Theme</label>
          <select class="input">
            <option>Dark (Default)</option>
            <option>Light</option>
            <option>Auto</option>
          </select>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px;">Backend URL</label>
          <input type="text" class="input" id="backendUrl" value="http://localhost:5001" placeholder="http://localhost:5001">
        </div>
        <button class="btn" onclick="CalOS.saveSettings()">Save Settings</button>
      </div>

      <div class="card" style="margin-top: 15px;">
        <h3 style="margin-bottom: 10px;">About CalOS</h3>
        <p style="color: var(--text-secondary); line-height: 1.6;">
          <strong>Version:</strong> 1.0.0<br>
          <strong>Mode:</strong> Self-Contained<br>
          <strong>Storage:</strong> localStorage + IndexedDB<br>
          <strong>Offline:</strong> Fully Capable<br>
          <strong>Privacy:</strong> All data stored locally
        </p>
      </div>
    </div>
  </div>

  <!-- Calculator Window -->
  <div id="calculatorWindow" class="window" style="top: 220px; left: 400px; width: 350px; height: 500px;">
    <div class="window-titlebar" onmousedown="CalOS.startDrag(event, 'calculatorWindow')">
      <div class="window-title" data-i18n="calculator">Calculator</div>
      <div class="window-controls">
        <div class="window-control close" onclick="CalOS.closeWindow('calculatorWindow')"></div>
        <div class="window-control minimize"></div>
        <div class="window-control maximize" onclick="CalOS.toggleMaximize('calculatorWindow')"></div>
      </div>
    </div>
    <!-- Resize Handles -->
    <div class="window-resize-handle top" onmousedown="CalOS.startResize(event, 'calculatorWindow', 'top')"></div>
    <div class="window-resize-handle right" onmousedown="CalOS.startResize(event, 'calculatorWindow', 'right')"></div>
    <div class="window-resize-handle bottom" onmousedown="CalOS.startResize(event, 'calculatorWindow', 'bottom')"></div>
    <div class="window-resize-handle left" onmousedown="CalOS.startResize(event, 'calculatorWindow', 'left')"></div>
    <div class="window-resize-handle top-left" onmousedown="CalOS.startResize(event, 'calculatorWindow', 'top-left')"></div>
    <div class="window-resize-handle top-right" onmousedown="CalOS.startResize(event, 'calculatorWindow', 'top-right')"></div>
    <div class="window-resize-handle bottom-left" onmousedown="CalOS.startResize(event, 'calculatorWindow', 'bottom-left')"></div>
    <div class="window-resize-handle bottom-right" onmousedown="CalOS.startResize(event, 'calculatorWindow', 'bottom-right')"></div>
    <div class="window-content" style="padding: 0; display: flex; flex-direction: column;">
      <div style="padding: 20px; background: var(--bg-primary); border-bottom: 1px solid var(--border);">
        <div id="calcDisplay" style="font-size: 32px; text-align: right; padding: 15px; background: var(--bg-tertiary); border-radius: 8px; min-height: 70px; word-wrap: break-word;">0</div>
      </div>
      <div style="padding: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; flex: 1;">
        <button onclick="CalOS.calc('C')" class="btn btn-danger" style="grid-column: span 2;">C</button>
        <button onclick="CalOS.calc('DEL')" class="btn btn-secondary">DEL</button>
        <button onclick="CalOS.calc('/')" class="btn btn-secondary">/</button>

        <button onclick="CalOS.calc('7')" class="btn btn-secondary">7</button>
        <button onclick="CalOS.calc('8')" class="btn btn-secondary">8</button>
        <button onclick="CalOS.calc('9')" class="btn btn-secondary">9</button>
        <button onclick="CalOS.calc('*')" class="btn btn-secondary">×</button>

        <button onclick="CalOS.calc('4')" class="btn btn-secondary">4</button>
        <button onclick="CalOS.calc('5')" class="btn btn-secondary">5</button>
        <button onclick="CalOS.calc('6')" class="btn btn-secondary">6</button>
        <button onclick="CalOS.calc('-')" class="btn btn-secondary">−</button>

        <button onclick="CalOS.calc('1')" class="btn btn-secondary">1</button>
        <button onclick="CalOS.calc('2')" class="btn btn-secondary">2</button>
        <button onclick="CalOS.calc('3')" class="btn btn-secondary">3</button>
        <button onclick="CalOS.calc('+')" class="btn btn-secondary">+</button>

        <button onclick="CalOS.calc('0')" class="btn btn-secondary" style="grid-column: span 2;">0</button>
        <button onclick="CalOS.calc('.')" class="btn btn-secondary">.</button>
        <button onclick="CalOS.calc('=')" class="btn btn-success">=</button>
      </div>
    </div>
  </div>

  <script>
    // CalOS - Self-Contained Operating System
    window.CalOS = {
      version: '1.0.0',
      currentLanguage: 'en',
      draggedWindow: null,
      dragOffset: { x: 0, y: 0 },

      // Translation System
      translations: {
        en: {
          files: 'Files',
          chat: 'Chat',
          apikeys: 'API Keys',
          models: 'Models',
          appstore: 'App Store',
          settings: 'Settings',
          calculator: 'Calculator',
          auth: 'Login / Register'
        },
        es: {
          files: 'Archivos',
          chat: 'Chat',
          apikeys: 'Claves API',
          models: 'Modelos',
          appstore: 'Tienda',
          settings: 'Configuración',
          calculator: 'Calculadora',
          auth: 'Iniciar Sesión / Registrarse'
        },
        business: {
          files: 'Documents',
          chat: 'Communications',
          apikeys: 'Integration Keys',
          models: 'AI Models',
          appstore: 'Solutions Marketplace',
          settings: 'Preferences',
          calculator: 'Business Calculator',
          auth: 'Authentication'
        }
      },

      // Platform Detection
      platform: {
        type: 'web', // 'ios', 'android', 'web', 'desktop'
        isNative: false,
        isCapacitor: false,
        device: {},
        network: {}
      },

      async detectPlatform() {
        console.log('[CalOS] Detecting platform...');

        // Check if Capacitor is available
        if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
          this.platform.isCapacitor = true;
          this.platform.isNative = true;

          try {
            // Get device info
            const { Device } = Capacitor.Plugins;
            this.platform.device = await Device.getInfo();
            this.platform.type = this.platform.device.platform; // 'ios' or 'android'

            // Get network info
            const { Network } = Capacitor.Plugins;
            this.platform.network = await Network.getStatus();

            // Setup iOS-specific features
            if (this.platform.type === 'ios') {
              const { StatusBar } = Capacitor.Plugins;
              await StatusBar.setStyle({ style: 'dark' });
              await StatusBar.setBackgroundColor({ color: '#0a0a0a' });
            }

            console.log('[CalOS] Platform:', this.platform.type.toUpperCase(), 'Native');
          } catch (e) {
            console.warn('[CalOS] Capacitor plugins unavailable:', e.message);
          }
        } else {
          // Fallback to user agent detection
          const ua = navigator.userAgent.toLowerCase();

          if (/iphone|ipad|ipod/.test(ua)) {
            this.platform.type = 'ios';
          } else if (/android/.test(ua)) {
            this.platform.type = 'android';
          } else if (/electron/.test(ua)) {
            this.platform.type = 'desktop';
          } else {
            this.platform.type = 'web';
          }

          console.log('[CalOS] Platform:', this.platform.type.toUpperCase(), 'Web');
        }

        // Update platform badge
        this.updatePlatformBadge();

        return this.platform;
      },

      updatePlatformBadge() {
        const badge = document.getElementById('platformBadge');
        const container = document.getElementById('platformInfo');

        if (!badge || !container) return;

        const icons = {
          ios: '📱',
          android: '🤖',
          web: '🌐',
          desktop: '💻'
        };

        const labels = {
          ios: this.platform.isNative ? 'iOS Native' : 'iOS Web',
          android: this.platform.isNative ? 'Android Native' : 'Android Web',
          web: 'Web',
          desktop: 'Desktop'
        };

        badge.textContent = `${icons[this.platform.type]} ${labels[this.platform.type]}`;
        container.style.display = 'flex';
      },

      // Initialize OS
      async init() {
        console.log('[CalOS] Booting...');

        // Detect platform first
        await this.detectPlatform();

        // Initialize storage
        this.storage = {
          files: JSON.parse(localStorage.getItem('calos_files') || '{}'),
          keys: JSON.parse(localStorage.getItem('calos_keys') || '{}'),
          settings: JSON.parse(localStorage.getItem('calos_settings') || '{"backendUrl":"http://localhost:5001"}'),
          installed_apps: JSON.parse(localStorage.getItem('calos_apps') || '[]')
        };

        // Check online status
        this.checkOnlineStatus();
        setInterval(() => this.checkOnlineStatus(), 5000);

        // Update clock
        this.updateClock();
        setInterval(() => this.updateClock(), 1000);

        // Update storage info
        this.updateStorageInfo();

        // Load translations
        this.updateTranslations();

        // Hide boot screen after 2s
        setTimeout(() => {
          document.getElementById('bootScreen').classList.add('hidden');
          document.querySelector('.desktop').style.display = 'flex';
          console.log('[CalOS] Boot complete!');
        }, 2000);

        // Register service worker
        if ('serviceWorker' in navigator) {
          this.registerServiceWorker();
        }

        // Load files list
        this.renderFilesList();

        // Load API keys
        this.renderKeysList();

        // Check if user is already logged in
        this.checkLoginStatus();
      },

      // Check online status
      async checkOnlineStatus() {
        const backendUrl = this.storage.settings.backendUrl || 'http://localhost:5001';
        try {
          const response = await fetch(`${backendUrl}/health`, { method: 'GET', timeout: 3000 });
          if (response.ok) {
            document.getElementById('statusDot').classList.remove('offline');
            document.getElementById('statusText').textContent = 'Online';
          } else {
            throw new Error('Backend unreachable');
          }
        } catch (e) {
          document.getElementById('statusDot').classList.add('offline');
          document.getElementById('statusText').textContent = 'Offline Mode';
        }
      },

      // Update clock
      updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString();
      },

      // Update storage info
      updateStorageInfo() {
        const used = new Blob([JSON.stringify(this.storage)]).size;
        document.getElementById('storageUsed').textContent = Math.round(used / 1024);
      },

      // Translation
      setLanguage(lang) {
        this.currentLanguage = lang;
        this.updateTranslations();
      },

      updateTranslations() {
        const elements = document.querySelectorAll('[data-i18n]');
        elements.forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (this.translations[this.currentLanguage][key]) {
            el.textContent = this.translations[this.currentLanguage][key];
          }
        });
      },

      // Authentication
      switchAuthTab(tab) {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');

        if (tab === 'login') {
          loginForm.style.display = 'block';
          registerForm.style.display = 'none';
          loginTab.style.borderBottom = '3px solid var(--accent-blue)';
          registerTab.style.borderBottom = 'none';
        } else {
          loginForm.style.display = 'none';
          registerForm.style.display = 'block';
          loginTab.style.borderBottom = 'none';
          registerTab.style.borderBottom = '3px solid var(--accent-blue)';
        }
      },

      async login() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');

        if (!email || !password) {
          errorDiv.textContent = 'Please enter email and password';
          errorDiv.style.display = 'block';
          return;
        }

        errorDiv.style.display = 'none';

        try {
          const backendUrl = this.storage.settings.backendUrl || 'http://localhost:5001';
          const response = await fetch(`${backendUrl}/api/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ email, password })
          });

          const data = await response.json();

          if (response.ok) {
            // Store user info
            this.storage.user = data.user;
            localStorage.setItem('calos_user', JSON.stringify(data.user));

            // Update UI
            this.showProfileView();

            // Show success message
            console.log('[CalOS] Login successful:', data.user.username);
          } else {
            errorDiv.textContent = data.message || 'Login failed';
            errorDiv.style.display = 'block';
          }
        } catch (error) {
          console.error('[CalOS] Login error:', error);
          errorDiv.textContent = 'Network error. Check backend connection.';
          errorDiv.style.display = 'block';
        }
      },

      async register() {
        const email = document.getElementById('registerEmail').value.trim();
        const username = document.getElementById('registerUsername').value.trim();
        const password = document.getElementById('registerPassword').value;
        const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
        const errorDiv = document.getElementById('registerError');

        if (!email || !username || !password || !passwordConfirm) {
          errorDiv.textContent = 'Please fill in all fields';
          errorDiv.style.display = 'block';
          return;
        }

        if (password !== passwordConfirm) {
          errorDiv.textContent = 'Passwords do not match';
          errorDiv.style.display = 'block';
          return;
        }

        if (password.length < 6) {
          errorDiv.textContent = 'Password must be at least 6 characters';
          errorDiv.style.display = 'block';
          return;
        }

        errorDiv.style.display = 'none';

        try {
          const backendUrl = this.storage.settings.backendUrl || 'http://localhost:5001';
          const response = await fetch(`${backendUrl}/api/auth/register`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ email, username, password })
          });

          const data = await response.json();

          if (response.ok) {
            // Store user info
            this.storage.user = data.user;
            localStorage.setItem('calos_user', JSON.stringify(data.user));

            // Update UI
            this.showProfileView();

            // Show success message
            console.log('[CalOS] Registration successful:', data.user.username);
          } else {
            errorDiv.textContent = data.message || 'Registration failed';
            errorDiv.style.display = 'block';
          }
        } catch (error) {
          console.error('[CalOS] Registration error:', error);
          errorDiv.textContent = 'Network error. Check backend connection.';
          errorDiv.style.display = 'block';
        }
      },

      logout() {
        // Clear user data
        delete this.storage.user;
        localStorage.removeItem('calos_user');

        // Reset UI
        document.getElementById('authFormView').style.display = 'block';
        document.getElementById('authProfileView').style.display = 'none';
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';

        console.log('[CalOS] Logged out');
      },

      showProfileView() {
        const user = this.storage.user;
        if (!user) return;

        // Update profile info
        document.getElementById('profileUsername').textContent = user.username || user.email;
        document.getElementById('profileEmail').textContent = user.email;

        // Switch views
        document.getElementById('authFormView').style.display = 'none';
        document.getElementById('authProfileView').style.display = 'block';
      },

      checkLoginStatus() {
        // Check if user is logged in from localStorage
        const userStr = localStorage.getItem('calos_user');
        if (userStr) {
          try {
            this.storage.user = JSON.parse(userStr);
            this.showProfileView();
          } catch (e) {
            console.error('[CalOS] Failed to parse user data');
          }
        }
      },

      // Window management
      openWindow(windowId) {
        const win = document.getElementById(windowId);
        win.classList.add('active');

        // Special loading for models window
        if (windowId === 'modelsWindow') {
          this.refreshModels();
        }
      },

      closeWindow(windowId) {
        document.getElementById(windowId).classList.remove('active');
      },

      toggleMaximize(windowId) {
        document.getElementById(windowId).classList.toggle('maximized');
      },

      // Drag & Drop
      startDrag(e, windowId) {
        const win = document.getElementById(windowId);
        if (win.classList.contains('maximized')) return;

        this.draggedWindow = win;
        const rect = win.getBoundingClientRect();
        this.dragOffset = {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };

        win.classList.add('dragging');

        document.addEventListener('mousemove', this.drag.bind(this));
        document.addEventListener('mouseup', this.stopDrag.bind(this));
      },

      drag(e) {
        if (!this.draggedWindow) return;
        this.draggedWindow.style.left = (e.clientX - this.dragOffset.x) + 'px';
        this.draggedWindow.style.top = (e.clientY - this.dragOffset.y) + 'px';
      },

      stopDrag() {
        if (this.draggedWindow) {
          this.draggedWindow.classList.remove('dragging');
        }
        this.draggedWindow = null;
        document.removeEventListener('mousemove', this.drag);
        document.removeEventListener('mouseup', this.stopDrag);
      },

      // Window Resize
      startResize(e, windowId, direction) {
        const win = document.getElementById(windowId);
        if (win.classList.contains('maximized')) return;

        e.stopPropagation();

        this.resizingWindow = win;
        this.resizeDirection = direction;

        const rect = win.getBoundingClientRect();
        this.resizeStart = {
          x: e.clientX,
          y: e.clientY,
          width: rect.width,
          height: rect.height,
          top: rect.top,
          left: rect.left
        };

        win.classList.add('resizing');

        document.addEventListener('mousemove', this.resize.bind(this));
        document.addEventListener('mouseup', this.stopResize.bind(this));
      },

      resize(e) {
        if (!this.resizingWindow) return;

        const dx = e.clientX - this.resizeStart.x;
        const dy = e.clientY - this.resizeStart.y;

        const minWidth = 400;
        const minHeight = 300;

        let newWidth = this.resizeStart.width;
        let newHeight = this.resizeStart.height;
        let newLeft = this.resizeStart.left;
        let newTop = this.resizeStart.top;

        // Resize based on direction
        if (this.resizeDirection.includes('right')) {
          newWidth = Math.max(minWidth, this.resizeStart.width + dx);
        }
        if (this.resizeDirection.includes('left')) {
          newWidth = Math.max(minWidth, this.resizeStart.width - dx);
          if (newWidth > minWidth) {
            newLeft = this.resizeStart.left + dx;
          }
        }
        if (this.resizeDirection.includes('bottom')) {
          newHeight = Math.max(minHeight, this.resizeStart.height + dy);
        }
        if (this.resizeDirection.includes('top')) {
          newHeight = Math.max(minHeight, this.resizeStart.height - dy);
          if (newHeight > minHeight) {
            newTop = this.resizeStart.top + dy;
          }
        }

        this.resizingWindow.style.width = newWidth + 'px';
        this.resizingWindow.style.height = newHeight + 'px';
        this.resizingWindow.style.left = newLeft + 'px';
        this.resizingWindow.style.top = newTop + 'px';
      },

      stopResize() {
        if (this.resizingWindow) {
          this.resizingWindow.classList.remove('resizing');
        }
        this.resizingWindow = null;
        this.resizeDirection = null;
        document.removeEventListener('mousemove', this.resize);
        document.removeEventListener('mouseup', this.stopResize);
      },

      // File System
      async uploadFile(file) {
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          this.storage.files[file.name] = {
            name: file.name,
            size: file.size,
            type: file.type,
            data: e.target.result,
            created: new Date().toISOString()
          };
          localStorage.setItem('calos_files', JSON.stringify(this.storage.files));
          this.renderFilesList();
          this.updateStorageInfo();
        };
        reader.readAsDataURL(file);
      },

      renderFilesList() {
        const list = document.getElementById('fileList');
        const files = Object.values(this.storage.files);

        if (files.length === 0) {
          list.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No files yet</p>';
          return;
        }

        list.innerHTML = files.map(file => `
          <div class="list-item">
            <div>
              <div style="font-weight: 600;">${file.name}</div>
              <div style="font-size: 12px; color: var(--text-secondary);">${Math.round(file.size / 1024)}KB - ${new Date(file.created).toLocaleString()}</div>
            </div>
            <button class="btn btn-danger" onclick="CalOS.deleteFile('${file.name}')">Delete</button>
          </div>
        `).join('');
      },

      deleteFile(filename) {
        if (confirm(`Delete ${filename}?`)) {
          delete this.storage.files[filename];
          localStorage.setItem('calos_files', JSON.stringify(this.storage.files));
          this.renderFilesList();
          this.updateStorageInfo();
        }
      },

      // API Keys
      async addApiKey() {
        const provider = document.getElementById('keyProvider').value;
        const key = document.getElementById('keyValue').value;

        if (!provider || !key) {
          alert('Please select a provider and enter an API key');
          return;
        }

        // Simple encryption (use proper crypto in production)
        const encrypted = btoa(key);

        this.storage.keys[provider] = {
          provider,
          key: encrypted,
          added: new Date().toISOString()
        };

        localStorage.setItem('calos_keys', JSON.stringify(this.storage.keys));

        document.getElementById('keyProvider').value = '';
        document.getElementById('keyValue').value = '';

        this.renderKeysList();
        this.updateStorageInfo();
      },

      renderKeysList() {
        const list = document.getElementById('keysList');
        const keys = Object.values(this.storage.keys);

        if (keys.length === 0) {
          list.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No API keys configured</p>';
          return;
        }

        list.innerHTML = keys.map(k => `
          <div class="list-item">
            <div>
              <div style="font-weight: 600;">${k.provider}</div>
              <div style="font-size: 12px; color: var(--accent-green);">Encrypted • ${new Date(k.added).toLocaleDateString()}</div>
            </div>
            <button class="btn btn-danger" onclick="CalOS.deleteKey('${k.provider}')">Delete</button>
          </div>
        `).join('');
      },

      deleteKey(provider) {
        if (confirm(`Delete ${provider} API key?`)) {
          delete this.storage.keys[provider];
          localStorage.setItem('calos_keys', JSON.stringify(this.storage.keys));
          this.renderKeysList();
          this.updateStorageInfo();
        }
      },

      // Models
      async refreshModels() {
        try {
          const response = await fetch('http://localhost:11434/api/tags');
          const data = await response.json();
          const models = data.models || [];

          document.getElementById('modelCount').textContent = models.length;

          const list = document.getElementById('modelsList');
          list.innerHTML = models.map(m => `
            <div class="list-item">
              <div>
                <div style="font-weight: 600;">${m.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                  ${Math.round(m.size / 1024 / 1024 / 1024 * 10) / 10}GB • ${m.details?.family || 'Unknown'}
                </div>
              </div>
              <button class="btn" onclick="CalOS.testModel('${m.name}')">Test</button>
            </div>
          `).join('');
        } catch (e) {
          document.getElementById('modelsList').innerHTML = `
            <p style="color: var(--accent-red); padding: 20px;">
              Ollama not available. Start with: <code>ollama serve</code>
            </p>
          `;
        }
      },

      async testModel(modelName) {
        alert(`Testing ${modelName}...\n\nThis would send a test prompt to Ollama.`);
      },

      // Chat
      async sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        const modelSelection = document.getElementById('chatModel').value;

        // Add user message
        this.addChatMessage('user', message);
        input.value = '';

        // Show typing indicator
        const typingDiv = this.addChatMessage('assistant', '...');
        typingDiv.id = 'typingIndicator';

        try {
          const backendUrl = this.storage.settings.backendUrl || 'http://localhost:5001';

          // Use direct Ollama route if Ollama is selected (bypasses bot detection)
          let response;
          if (modelSelection === 'ollama') {
            response = await fetch(`${backendUrl}/api/ollama/generate`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                model: 'llama3.2:3b', // Default model
                prompt: message
              })
            });
          } else {
            // Use multi-LLM router for external APIs (requires bot detection for now)
            let preferredProvider = null;
            if (modelSelection === 'openai') preferredProvider = 'openai';
            else if (modelSelection === 'anthropic') preferredProvider = 'anthropic';

            response = await fetch(`${backendUrl}/api/llm/complete`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              credentials: 'include',
              body: JSON.stringify({
                prompt: message,
                preferredProvider: preferredProvider
              })
            });
          }

          // Remove typing indicator
          const typing = document.getElementById('typingIndicator');
          if (typing) typing.remove();

          if (response.ok) {
            const data = await response.json();

            // Handle Ollama response format vs multi-LLM format
            let responseText, provider, model;
            if (modelSelection === 'ollama') {
              // Ollama direct route: { response: "text", model: "llama3.2:3b" }
              responseText = data.response || data.content || 'No response';
              provider = 'ollama';
              model = data.model || 'unknown';
            } else {
              // Multi-LLM router: { response: { text: "...", provider: "...", model: "..." } }
              responseText = data.response?.text || data.message || 'No response';
              provider = data.response?.provider || 'unknown';
              model = data.response?.model || 'unknown';
            }

            this.addChatMessage('assistant', `${responseText}\\n\\n_via ${provider}/${model}_`);
          } else {
            const error = await response.json();

            // If unauthorized (no access token), show friendly error with better guidance
            if (response.status === 401) {
              this.addChatMessage('assistant', `⚠️  External APIs require bot detection.\\n\\nTry switching to "Ollama" in the model selector for local AI chat.`);
            } else if (response.status === 503 && modelSelection === 'ollama') {
              this.addChatMessage('assistant', `❌ Ollama is not running.\\n\\nPlease start Ollama: npm run ollama:start`);
            } else {
              this.addChatMessage('assistant', `❌ Error: ${error.message || 'Request failed'}\\n\\nStatus: ${response.status}`);
            }
          }

        } catch (error) {
          // Remove typing indicator
          const typing = document.getElementById('typingIndicator');
          if (typing) typing.remove();

          console.error('[CalOS] Chat error:', error);
          this.addChatMessage('assistant', `❌ Network error: ${error.message}\\n\\nCheck that backend is running at ${this.storage.settings.backendUrl || 'http://localhost:5001'}`);
        }
      },

      addChatMessage(role, content) {
        const messages = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.style.cssText = `margin-bottom: 15px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${role === 'user' ? 'var(--accent-blue)' : 'var(--accent-green)'}`;
        div.innerHTML = `
          <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">${role === 'user' ? 'You' : 'Assistant'}</div>
          <div style="white-space: pre-wrap;">${content}</div>
        `;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
        return div; // Return the div so it can be manipulated
      },

      // App Store
      installApp(appId) {
        if (confirm(`Install ${appId} app?`)) {
          this.storage.installed_apps.push(appId);
          localStorage.setItem('calos_apps', JSON.stringify(this.storage.installed_apps));
          alert(`${appId} installed! (Demo)`);
        }
      },

      // Settings
      saveSettings() {
        this.storage.settings.backendUrl = document.getElementById('backendUrl').value;
        localStorage.setItem('calos_settings', JSON.stringify(this.storage.settings));
        alert('Settings saved!');
      },

      // Calculator (Offline tool - no server needed!)
      calcExpression: '',
      calcDisplay: '0',

      calc(input) {
        const display = document.getElementById('calcDisplay');

        if (input === 'C') {
          this.calcExpression = '';
          this.calcDisplay = '0';
        } else if (input === 'DEL') {
          this.calcExpression = this.calcExpression.slice(0, -1);
          this.calcDisplay = this.calcExpression || '0';
        } else if (input === '=') {
          try {
            // Safe eval using Function constructor
            this.calcDisplay = Function(`'use strict'; return (${this.calcExpression})`)();
            this.calcExpression = this.calcDisplay.toString();
          } catch (e) {
            this.calcDisplay = 'Error';
            this.calcExpression = '';
          }
        } else {
          this.calcExpression += input;
          this.calcDisplay = this.calcExpression;
        }

        if (display) {
          display.textContent = this.calcDisplay;
        }
      },

      // Service Worker
      async registerServiceWorker() {
        try {
          // Inline service worker for offline support
          const swCode = `
            self.addEventListener('install', (e) => {
              console.log('[SW] Install');
              self.skipWaiting();
            });

            self.addEventListener('activate', (e) => {
              console.log('[SW] Activate');
            });

            self.addEventListener('fetch', (e) => {
              // Cache-first strategy
              e.respondWith(
                caches.match(e.request).then(response => {
                  return response || fetch(e.request);
                })
              );
            });
          `;

          const blob = new Blob([swCode], { type: 'application/javascript' });
          const swUrl = URL.createObjectURL(blob);

          const registration = await navigator.serviceWorker.register(swUrl);
          console.log('[CalOS] Service Worker registered:', registration);
        } catch (e) {
          console.error('[CalOS] SW registration failed:', e);
        }
      }
    };

    // Boot CalOS
    window.addEventListener('DOMContentLoaded', () => CalOS.init());

    // Handle keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + K = Open chat
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        CalOS.openWindow('chatWindow');
      }
    });
  </script>
</body>
</html>
